db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $match: { "orders.o_totalprice": { $gt: 1000 }, "c_mktsegment": "AUTOMOBILE" } }, { $project: { _id: 0, c_name: 1, c_address: 1, "orders.o_totalprice": 1 } }])
var avgAcctBal = db.supplier.aggregate([{ $group: { _id: null, avg_acctbal: { $avg: "$s_acctbal" } } }]).toArray()[0].avg_acctbal; db.supplier.aggregate([{ $lookup: { from: "nation_region", localField: "s_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $match: { s_acctbal: { $gt: avgAcctBal }, "nation_data.nation.n_name": { $regex: /^A/ } } }, { $project: { _id: 0, s_name: 1, s_address: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $match: { $or: [ { "orders.o_totalprice": { $gt: 50000 } }, { "c_mktsegment": "BUILDING" } ] } }, { $project: { _id: 0, "orders.o_orderkey": 1, "orders.o_totalprice": 1, c_name: 1 } }])
db.nation_region.aggregate([{ $unwind: "$nation" }, { $group: { _id: { n_regionkey: "$nation.n_regionkey", r_name: "$r_name" }, total_nations: { $sum: 1 }, avg_region: { $avg: "$nation.n_regionkey" } } }, { $project: { _id: 0, n_regionkey: "$_id.n_regionkey", r_name: "$_id.r_name", total_nations: 1, avg_region: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $match: { "orders.o_orderstatus": "O" } }, { $project: { _id: 0, c_name: 1, "orders.o_totalprice": 1, "nation_data.nation.n_name": 1 } }])
db.supplier.aggregate([{ $lookup: { from: "nation_region", localField: "s_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: { path: "$nation_data", preserveNullAndEmptyArrays: true } }, { $unwind: { path: "$nation_data.nation", preserveNullAndEmptyArrays: true } }, { $lookup: { from: "partsupp_part", localField: "s_suppkey", foreignField: "partsupp.ps_suppkey", as: "partsupp_data" } }, { $unwind: { path: "$partsupp_data", preserveNullAndEmptyArrays: true } }, { $unwind: { path: "$partsupp_data.partsupp", preserveNullAndEmptyArrays: true } }, { $match: { "partsupp_data.partsupp.ps_supplycost": { $gt: 500 } } }, { $project: { _id: 0, s_name: 1, "nation_data.nation.n_name": 1, "partsupp_data.partsupp.ps_supplycost": 1 } }])
var avgRetailPrice = db.partsupp_part.aggregate([{ $group: { _id: null, avg_price: { $avg: "$p_retailprice" } } }]).toArray()[0].avg_price; db.partsupp_part.aggregate([{ $lookup: { from: "supplier", localField: "partsupp.ps_suppkey", foreignField: "s_suppkey", as: "supplier_data" } }, { $unwind: { path: "$supplier_data", preserveNullAndEmptyArrays: true } }, { $match: { p_retailprice: { $gt: avgRetailPrice } } }, { $project: { _id: 0, "partsupp.ps_partkey": 1, p_name: 1, "supplier_data.s_name": 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $match: { "orders.o_totalprice": { $gt: 10000 }, "nation_data.r_name": { $in: ["AMERICA", "EUROPE"] } } }, { $project: { _id: 0, c_name: 1, "orders.o_totalprice": 1, "nation_data.nation.n_name": 1, "nation_data.r_name": 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $unwind: "$orders.lineitem" }, { $match: { "orders.lineitem.l_discount": { $gt: 0.05 } } }, { $project: { _id: 0, c_name: 1, "orders.o_totalprice": 1, "nation_data.nation.n_name": 1, "nation_data.r_name": 1, "orders.lineitem.l_extendedprice": 1 } }])
db.lineitem_orders.aggregate([{ $group: { _id: "$o_orderstatus", total_sales: { $sum: { $toDouble: "$o_totalprice" } } } }, { $match: { total_sales: { $gt: 1000000 } } }, { $project: { _id: 0, order_status: "$_id", total_sales: 1 } }])
var nationCounts = db.supplier.aggregate([{ $group: { _id: "$s_nationkey", count: { $sum: 1 } } }]).toArray(); var minCount = Math.min(...nationCounts.map(n => n.count)); db.supplier.aggregate([{ $lookup: { from: "nation_region", localField: "s_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: { s_nationkey: "$s_nationkey", n_name: "$nation_data.nation.n_name" }, total_suppliers: { $sum: 1 } } }, { $match: { total_suppliers: { $gt: minCount } } }, { $project: { _id: 0, s_nationkey: "$_id.s_nationkey", n_name: "$_id.n_name", total_suppliers: 1 } }])
db.lineitem.aggregate([{ $group: { _id: null, global_avg_price: { $avg: "$l_extendedprice" } } }, { $lookup: { from: "lineitem", pipeline: [ { $group: { _id: "$l_returnflag", avg_price: { $avg: "$l_extendedprice" } } }, { $project: { _id: 0, l_returnflag: "$_id", avg_price: 1 } } ], as: "grouped_data" } }, { $unwind: "$grouped_data" }, { $match: { "grouped_data.avg_price": { $gt: "$global_avg_price" } } }, { $project: { _id: 0, l_returnflag: "$grouped_data.l_returnflag", avg_price: "$grouped_data.avg_price" } }])
db.lineitem.aggregate([{ $match: { l_shipdate: { $gte: "1994-01-01", $lte: "1995-12-31" } } }, { $project: { _id: 0, l_orderkey: 1, final_price: { $multiply: [ "$l_extendedprice", { $subtract: [1, "$l_discount"] }, { $add: [1, "$l_tax"] } ] } } }])
db.lineitem_orders.aggregate([{ $match: { o_totalprice: { $gt: 20000 } } }, { $group: { _id: { o_orderkey: "$o_orderkey", o_orderstatus: "$o_orderstatus", o_totalprice: "$o_totalprice" } } }, { $project: { _id: 0, o_orderkey: "$_id.o_orderkey", o_orderstatus: "$_id.o_orderstatus", o_totalprice: "$_id.o_totalprice" } }])
db.customer.aggregate([{ $sort: { c_acctbal: -1 } }, { $skip: 10 }, { $limit: 20 }, { $project: { _id: 0, c_name: 1, c_acctbal: 1 } }])
db.lineitem_orders.aggregate([{ $facet: { avg_price_calc: [{ $group: { _id: null, avg_price: { $avg: "$o_totalprice" } } }], customers_max_price: [{ $group: { _id: "$o_custkey", max_order_price: { $max: "$o_totalprice" } } }] } }, { $unwind: "$avg_price_calc" }, { $set: { avg_price: "$avg_price_calc.avg_price" } }, { $project: { avg_price_calc: 0 } }, { $unwind: "$customers_max_price" }, { $match: { $expr: { $gt: ["$customers_max_price.max_order_price", "$avg_price"] } } }, { $lookup: { from: "customer", localField: "customers_max_price._id", foreignField: "c_custkey", as: "customer_data" } }, { $unwind: "$customer_data" }, { $project: { _id: 0, c_name: "$customer_data.c_name" } }])
db.customer.aggregate([{ $facet: { avg_acctbal_calc: [{ $group: { _id: null, avg_acctbal: { $avg: "$c_acctbal" } } }], customers_data: [{ $project: { _id: 0, c_name: 1, c_acctbal: 1 } }] } }, { $unwind: "$avg_acctbal_calc" }, { $set: { avg_acctbal: "$avg_acctbal_calc.avg_acctbal" } }, { $project: { avg_acctbal_calc: 0 } }, { $unwind: "$customers_data" }, { $addFields: { "customers_data.customer_status": { $cond: { if: { $gt: ["$customers_data.c_acctbal", "$avg_acctbal"] }, then: "VIP", else: "Regular" } } } }, { $replaceRoot: { newRoot: "$customers_data" } }])
db.customer.aggregate([{ $group: { _id: "$c_custkey" } }, { $count: "total_customers" }])
db.customer.aggregate([{ $group: { _id: null, min_balance: { $min: "$c_acctbal" }, max_balance: { $max: "$c_acctbal" } } }, { $project: { _id: 0, min_balance: 1, max_balance: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_mktsegment", total_revenue: { $sum: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_mktsegment: "$_id", total_revenue: 1 } }])
db.customer.aggregate([{ $group: { _id: "$c_mktsegment", num_customers: { $sum: 1 } } }, { $match: { num_customers: { $gt: 10 } } }, { $project: { _id: 0, c_mktsegment: "$_id", num_customers: 1 } }])
db.lineitem_orders.aggregate([{ $facet: { avg_price_calc: [{ $group: { _id: null, avg_totalprice: { $avg: "$o_totalprice" } } }], customers_above_avg: [{ $group: { _id: "$o_custkey", max_order_price: { $max: "$o_totalprice" } } }] } }, { $unwind: "$avg_price_calc" }, { $set: { avg_totalprice: "$avg_price_calc.avg_totalprice" } }, { $project: { avg_price_calc: 0 } }, { $unwind: "$customers_above_avg" }, { $match: { $expr: { $gt: ["$customers_above_avg.max_order_price", "$avg_totalprice"] } } }, { $lookup: { from: "customer", localField: "customers_above_avg._id", foreignField: "c_custkey", as: "customer_data" } }, { $unwind: "$customer_data" }, { $project: { _id: 0, c_name: "$customer_data.c_name" } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $match: { "orders.o_totalprice": { $gt: 20000 }, "nation_data.r_name": "AMERICA" } }, { $project: { _id: 0, c_name: 1, o_totalprice: "$orders.o_totalprice", n_name: "$nation_data.nation.n_name", r_name: "$nation_data.r_name" } }])
db.partsupp.aggregate([{ $facet: { avg_cost_calc: [{ $group: { _id: null, avg_supplycost: { $avg: "$ps_supplycost" } } }], parts_with_supplier: [{ $lookup: { from: "supplier", localField: "ps_suppkey", foreignField: "s_suppkey", as: "supplier_data" } }, { $unwind: "$supplier_data" }] } }, { $unwind: "$avg_cost_calc" }, { $set: { avg_supplycost: "$avg_cost_calc.avg_supplycost" } }, { $project: { avg_cost_calc: 0 } }, { $unwind: "$parts_with_supplier" }, { $match: { $expr: { $gt: ["$parts_with_supplier.ps_supplycost", "$avg_supplycost"] } } }, { $group: { _id: "$parts_with_supplier.supplier_data.s_name" } }, { $project: { _id: 0, s_namse: "$_id" } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $setWindowFields: { partitionBy: "$c_custkey", sortBy: { "orders.o_orderkey": 1 }, output: { moving_avg: { $avg: "$orders.o_totalprice" } } } }, { $project: { _id: 0, c_name: 1, o_totalprice: "$orders.o_totalprice", moving_avg: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $match: { "orders.o_totalprice": { $gt: 10000 } } }, { $project: { _id: 0, c_name: 1, c_address: 1 } }])
db.customer.aggregate([{ $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $match: { "nation_data.r_name": { $in: ["AMERICA", "EUROPE"] } } }, { $project: { _id: 0, c_name: 1 } }])
db.customer.aggregate([{ $lookup: { from: "customer", localField: "c_nationkey", foreignField: "c_nationkey", as: "paired_customers" } }, { $unwind: "$paired_customers" }, { $match: { $expr: { $lt: ["$c_custkey", "$paired_customers.c_custkey"] } } }, { $project: { _id: 0, client1: "$c_name", client2: "$paired_customers.c_name", c_nationkey: 1 } }])
db.lineitem_orders.aggregate([{ $lookup: { from: "lineitem", localField: "o_orderkey", foreignField: "l_orderkey", as: "lineitems" } }, { $unwind: { path: "$lineitems", preserveNullAndEmptyArrays: true } }, { $project: { _id: 0, o_orderkey: 1, o_totalprice: 1, l_partkey: "$lineitems.l_partkey", l_extendedprice: "$lineitems.l_extendedprice" } }, { $unionWith: { coll: "lineitem", pipeline: [ { $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", as: "orders" } }, { $match: { orders: { $size: 0 } } }, { $project: { _id: 0, o_orderkey: "$l_orderkey", o_totalprice: null, l_partkey: 1, l_extendedprice: 1 } } ] } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: { c_name: "$c_name", r_name: "$nation_data.r_name" }, total_spent: { $sum: "$orders.o_totalprice" } } }, { $setWindowFields: { partitionBy: "$_id.r_name", sortBy: { total_spent: -1 }, output: { ranking: { $rank: {} } } } }, { $project: { _id: 0, c_name: "$_id.c_name", r_name: "$_id.r_name", total_spent: 1, ranking: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $match: { orders: { $size: 0 } } }, { $project: { _id: 0, c_name: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $match: { "orders.o_totalprice": { $exists: true }, $or: [ { "orders.o_totalprice": { $gt: 50000 } }, { "orders.o_totalprice": { $lt: 5000 } } ] } }, { $group: { _id: "$c_name", count_high: { $sum: { $cond: [{ $gt: ["$orders.o_totalprice", 50000] }, 1, 0] } }, count_low: { $sum: { $cond: [{ $lt: ["$orders.o_totalprice", 5000] }, 1, 0] } } } }, { $match: { count_high: { $gt: 0 }, count_low: { $gt: 0 } } }, { $project: { _id: 0, c_name: "$_id" } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "lineitem", localField: "orders.o_orderkey", foreignField: "l_orderkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "partsupp_part", localField: "lineitems.l_partkey", foreignField: "p_partkey", as: "parts" } }, { $unwind: "$parts" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nations" } }, { $unwind: "$nations" }, { $match: { "orders.o_totalprice": { $gt: 50000 } } }, { $project: { c_name: 1, o_orderkey: "$orders.o_orderkey", o_totalprice: "$orders.o_totalprice", p_name: "$parts.p_name", n_name: "$nations.n_name", _id: 0 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_mktsegment", num_customers: { $sum: 1 }, total_sales: { $sum: "$orders.o_totalprice" } } }, { $match: { num_customers: { $gt: 10 } } }, { $project: { _id: 0, c_mktsegment: "$_id", num_customers: 1, total_sales: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", pipeline: [{ $group: { _id: null, avg_totalprice: { $avg: "$o_totalprice" } } }], as: "avg_price_data" } }, { $set: { avg_totalprice: { $arrayElemAt: ["$avg_price_data.avg_totalprice", 0] } } }, { $set: { c_custkey: { $toInt: "$c_custkey" } } }, { $lookup: { from: "lineitem_orders", let: { cust_key: "$c_custkey", avg_price: "$avg_totalprice" }, pipeline: [{ $match: { $expr: { $and: [ { $eq: ["$o_custkey", "$$cust_key"] }, { $gt: ["$o_totalprice", "$$avg_price"] } ] } } }], as: "high_value_orders" } }, { $match: { "high_value_orders": { $ne: [] } } }, { $project: { _id: 0, c_name: 1 } }])
db.customer.aggregate([{ $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $match: { "nation_data.r_name": { $in: ["AMERICA", "EUROPE"] } } }, { $project: { _id: 0, c_name: 1, r_name: "$nation_data.r_name" } }])
db.lineitem_orders.aggregate([{ $sort: { o_custkey: 1, o_orderdate: -1 } }, { $group: { _id: "$o_custkey", latest_order: { $first: "$$ROOT" } } }, { $project: { _id: 0, o_custkey: "$latest_order.o_custkey", o_orderdate: "$latest_order.o_orderdate", o_totalprice: "$latest_order.o_totalprice" } }, { $sort: { o_custkey: 1 } }])
db.lineitem_orders.aggregate([{ $addFields: { order_category: { $switch: { branches: [ { case: { $gt: ["$o_totalprice", 50000] }, then: "High Value" }, { case: { $gt: ["$o_totalprice", 10000] }, then: "Medium Value" } ], default: "Low Value" } } } }, { $group: { _id: "$order_category", num_orders: { $sum: 1 } } }, { $project: { _id: 0, order_category: "$_id", num_orders: 1 } }, { $sort: { order_category: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_name", total_spent: { $sum: "$orders.o_totalprice" } } }, { $sort: { total_spent: -1 } }, { $limit: 10 }, { $project: { _id: 0, c_name: "$_id", total_spent: 1 } }])
db.customer.aggregate([{ $lookup: { from: "customer", let: { nation_key: "$c_nationkey", cust_key: "$c_custkey" }, pipeline: [ { $match: { $expr: { $and: [ { $eq: ["$c_nationkey", "$$nation_key"] }, { $gt: ["$c_custkey", "$$cust_key"] } ] } } }, { $project: { _id: 0, c_name: 1, c_custkey: 1 } } ], as: "paired_customers" } }, { $unwind: "$paired_customers" }, { $project: { _id: 0, client1: "$c_name", client2: "$paired_customers.c_name", c_nationkey: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $match: { "orders": { $size: 0 } } }, { $project: { _id: 0, c_name: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_name", has_high_order: { $max: { $gt: ["$orders.o_totalprice", 40000] } }, has_low_order: { $max: { $lt: ["$orders.o_totalprice", 8000] } } } }, { $match: { has_high_order: true, has_low_order: true } }, { $project: { _id: 0, c_name: "$_id" } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: { c_name: "$c_name", n_name: "$nation_data.nation.n_name" }, total_spent: { $sum: "$orders.o_totalprice" } } }, { $match: { total_spent: { $gt: 5000 } } }, { $setWindowFields: { partitionBy: "$_id.n_name", sortBy: { total_spent: -1 }, output: { rank: { $rank: {} } } } }, { $project: { _id: 0, c_name: "$_id.c_name", n_name: "$_id.n_name", total_spent: 1, rank: 1 } }, { $sort: { n_name: 1, rank: 1 } }])
db.nation_region.aggregate([{ $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: { r_name: "$r_name", n_name: "$nation.n_name" }, total_sales: { $sum: "$orders.o_totalprice" } } }, { $group: { _id: "$_id.r_name", nations: { $push: { n_name: "$_id.n_name", total_sales: "$total_sales" } }, region_total: { $sum: "$total_sales" } } }, { $group: { _id: null, regions: { $push: { r_name: "$_id", nations: "$nations", region_total: "$region_total" } }, grand_total: { $sum: "$region_total" } } }, { $project: { _id: 0, regions: 1, grand_total: 1 } }])
db.lineitem_orders.aggregate([{ $addFields: { order_year: { $year: { $dateFromString: { dateString: "$o_orderdate" } } }, order_month: { $month: { $dateFromString: { dateString: "$o_orderdate" } } } } }, { $group: { _id: "$order_year", spring_sales: { $sum: { $cond: [{ $in: ["$order_month", [3, 4, 5]] }, "$o_totalprice", 0] } }, summer_sales: { $sum: { $cond: [{ $in: ["$order_month", [6, 7, 8]] }, "$o_totalprice", 0] } }, autumn_sales: { $sum: { $cond: [{ $in: ["$order_month", [9, 10, 11]] }, "$o_totalprice", 0] } }, winter_sales: { $sum: { $cond: [{ $in: ["$order_month", [12, 1, 2]] }, "$o_totalprice", 0] } } } }, { $project: { _id: 0, order_year: "$_id", spring_sales: 1, summer_sales: 1, autumn_sales: 1, winter_sales: 1 } }, { $sort: { order_year: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_orderkey: 1 } }], as: "orders" } }, { $match: { "orders": { $ne: [] } } }, { $addFields: { order_keys: "$orders.o_orderkey" } }, { $lookup: { from: "lineitem", localField: "order_keys", foreignField: "l_orderkey", pipeline: [{ $project: { _id: 0, l_partkey: 1 } }], as: "lineitems" } }, { $match: { "lineitems": { $ne: [] } } }, { $addFields: { part_keys: "$lineitems.l_partkey" } }, { $lookup: { from: "partsupp_part", localField: "part_keys", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1 } }], as: "products" } }, { $match: { "products": { $ne: [] } } }, { $group: { _id: "$c_name", purchased_products: { $addToSet: "$products.p_name" } } }, { $project: { _id: 0, c_name: "$_id", purchased_products: { $reduce: { input: "$purchased_products", initialValue: [], in: { $setUnion: ["$$value", "$$this"] } } } } }, { $sort: { c_name: 1 } }])
db.supplier.aggregate([{ $lookup: { from: "partsupp", localField: "s_suppkey", foreignField: "ps_suppkey", as: "supplied_parts" } }, { $project: { _id: 0, s_name: 1, total_supplied: { $size: "$supplied_parts" } } }, { $sort: { total_supplied: -1 } }, { $limit: 10 }])
db.lineitem_orders.aggregate([{ $addFields: { order_year: { $year: { $dateFromString: { dateString: "$o_orderdate" } } } }, { $group: { _id: "$order_year", total_sales: { $sum: "$o_totalprice" } } }, { $setWindowFields: { sortBy: { "_id": 1 }, output: { prev_year_sales: { $shift: { output: "$total_sales", by: -1 } } } } }, { $addFields: { sales_growth: { $subtract: ["$total_sales", "$prev_year_sales"] } } }, { $project: { _id: 0, order_year: "$_id", total_sales: 1, sales_growth: 1 } }, { $sort: { order_year: 1 } }])
db.lineitem_orders.aggregate([{ $project: { _id: 0, o_orderkey: 1, o_totalprice: 1, o_custkey: 1 } }, { $setWindowFields: { partitionBy: null, sortBy: { o_totalprice: 1 }, output: { prev_orderkey: { $shift: { by: -1, output: "$o_orderkey" } }, prev_totalprice: { $shift: { by: -1, output: "$o_totalprice" } }, prev_custkey: { $shift: { by: -1, output: "$o_custkey" } } } } }, { $match: { $expr: { $lt: [{ $abs: { $subtract: ["$o_totalprice", "$prev_totalprice"] } }, 100] } } }, { $lookup: { from: "customer", localField: "o_custkey", foreignField: "c_custkey", as: "customer1" } }, { $unwind: "$customer1" }, { $lookup: { from: "customer", localField: "prev_custkey", foreignField: "c_custkey", as: "customer2" } }, { $unwind: "$customer2" }, { $project: { customer1: "$customer1.c_name", customer2: "$customer2.c_name", price_difference: { $abs: { $subtract: ["$o_totalprice", "$prev_totalprice"] } } } }, { $sort: { price_difference: 1 } }, { $limit: 20 }])
db.lineitem_orders.aggregate([{ $addFields: { order_year: { $year: { $dateFromString: { dateString: "$o_orderdate" } } } }, { $group: { _id: "$order_year", total_sales: { $sum: "$o_totalprice" } } }, { $setWindowFields: { sortBy: { "_id": 1 }, output: { prev_year_sales: { $shift: { output: "$total_sales", by: -1 } } } } }, { $addFields: { sales_growth: { $subtract: ["$total_sales", "$prev_year_sales"] } } }, { $project: { _id: 0, order_year: "$_id", total_sales: 1, sales_growth: 1 } }, { $sort: { order_year: 1 } }])
db.lineitem_orders.aggregate([{ $facet: { high_value_orders: [{ $match: { o_totalprice: { $gt: 70000 } } }, { $project: { _id: 0, category: "High Value", o_orderkey: 1, o_totalprice: 1 } }], low_value_orders: [{ $match: { o_totalprice: { $lt: 8000 } } }, { $project: { _id: 0, category: "Low Value", o_orderkey: 1, o_totalprice: 1 } }] } }, { $project: { combined_results: { $concatArrays: ["$high_value_orders", "$low_value_orders"] } } }, { $unwind: "$combined_results" }, { $project: { _id: 0, category: "$combined_results.category", o_orderkey: "$combined_results.o_orderkey", o_totalprice: "$combined_results.o_totalprice" } }])
db.lineitem_orders.aggregate([{ $lookup: { from: "lineitem", localField: "o_orderkey", foreignField: "l_orderkey", pipeline: [{ $group: { _id: "$l_orderkey", total_quantity: { $sum: "$l_quantity" } } }], as: "order_quantities" } }, { $match: { "order_quantities.0": { $exists: true } } }, { $addFields: { total_weighted_price: { $multiply: ["$o_totalprice", { $arrayElemAt: ["$order_quantities.total_quantity", 0] }] } } }, { $group: { _id: "$o_custkey", total_weighted_price: { $sum: "$total_weighted_price" }, total_quantity: { $sum: { $arrayElemAt: ["$order_quantities.total_quantity", 0] } } } }, { $lookup: { from: "customer", localField: "_id", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $addFields: { weighted_avg_price: { $divide: ["$total_weighted_price", "$total_quantity"] } } }, { $project: { _id: 0, c_name: "$customer_data.c_name", weighted_avg_price: 1 } }, { $sort: { weighted_avg_price: -1 } }])
db.lineitem_orders.aggregate([{ $addFields: { sales_month: { $dateTrunc: { date: { $dateFromString: { dateString: "$o_orderdate" } }, unit: "month" } } }, { $group: { _id: "$sales_month", total_sales: { $sum: "$o_totalprice" } } }, { $setWindowFields: { sortBy: { "_id": 1 }, output: { prev_sales: { $shift: { output: "$total_sales", by: -1 } } } } }, { $addFields: { growth_rate: { $multiply: [{ $cond: { if: { $eq: ["$prev_sales", null] }, then: null, else: { $divide: [{ $subtract: ["$total_sales", "$prev_sales"] }, "$prev_sales"] } } }, 100] } } }, { $project: { _id: 0, sales_month: "$_id", total_sales: 1, growth_rate: 1 } }, { $sort: { sales_month: 1 } }])
db.partsupp_part.aggregate([{ $lookup: { from: "partsupp", localField: "p_partkey", foreignField: "ps_partkey", pipeline: [{ $project: { _id: 0, ps_suppkey: 1, ps_supplycost: 1 } }], as: "supply_data" } }, { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", pipeline: [{ $project: { _id: 0, l_quantity: 1, l_extendedprice: 1 } }], as: "lineitems" } }, { $addFields: { total_cost: { $sum: { $map: { input: "$lineitems", as: "line", in: { $multiply: [{ $arrayElemAt: ["$supply_data.ps_supplycost", 0] }, "$$line.l_quantity"] } } } }, total_revenue: { $sum: "$lineitems.l_extendedprice" } } }, { $addFields: { profit_margin: { $subtract: ["$total_revenue", "$total_cost"] } } }, { $project: { _id: 0, p_name: 1, total_revenue: 1, total_cost: 1, profit_margin: 1 } }, { $sort: { profit_margin: -1 } }])
db.lineitem.aggregate([{ $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", pipeline: [{ $project: { _id: 0, o_custkey: 1 } }], as: "order_data" } }, { $unwind: "$order_data" }, { $group: { _id: "$l_partkey", unique_customers: { $addToSet: "$order_data.o_custkey" } } }, { $lookup: { from: "partsupp", localField: "_id", foreignField: "ps_partkey", pipeline: [{ $project: { _id: 0, ps_suppkey: 1 } }], as: "supplier_data" } }, { $unwind: "$supplier_data" }, { $group: { _id: "$supplier_data.ps_suppkey", unique_customers: { $addToSet: "$unique_customers" } } }, { $addFields: { unique_customers: { $reduce: { input: "$unique_customers", initialValue: [], in: { $setUnion: ["$$value", "$$this"] } } } } }, { $addFields: { unique_customer_count: { $size: "$unique_customers" } } }, { $lookup: { from: "supplier", localField: "_id", foreignField: "s_suppkey", pipeline: [{ $project: { _id: 0, s_name: 1 } }], as: "supplier_info" } }, { $unwind: "$supplier_info" }, { $match: { unique_customer_count: { $gte: 20 } } }, { $project: { _id: 0, s_name: "$supplier_info.s_name", unique_customer_count: 1 } }, { $sort: { unique_customer_count: -1 } }])
db.nation_region.aggregate([{ $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: { region: "$r_name", nation: "$nation.n_name" }, total_sales: { $sum: "$orders.o_totalprice" } } }, { $unionWith: { coll: "nation_region", pipeline: [ { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: { region: "$r_name" }, total_sales: { $sum: "$orders.o_totalprice" } } } ] } }, { $unionWith: { coll: "nation_region", pipeline: [ { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: null, total_sales: { $sum: "$orders.o_totalprice" } } } ] } }, { $project: { _id: 0, region: "$_id.region", nation: "$_id.nation", total_sales: 1 } }, { $sort: { region: 1, nation: 1 } }])
db.lineitem_orders.aggregate([{ $group: { _id: "$o_custkey", total_spending: { $sum: "$o_totalprice" } } }, { $lookup: { from: "customer", localField: "_id", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $lookup: { from: "lineitem_orders", pipeline: [ { $group: { _id: "$o_custkey", total_spending: { $sum: "$o_totalprice" } } }, { $lookup: { from: "customer", localField: "_id", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" } ], as: "customer_pairs" } }, { $unwind: "$customer_pairs" }, { $match: { $expr: { $ne: ["$_id", "$customer_pairs._id"] } } }, { $addFields: { spending_difference: { $abs: { $subtract: ["$total_spending", "$customer_pairs.total_spending"] } } } }, { $match: { spending_difference: { $lt: 5000 } } }, { $project: { _id: 0, customer1: "$customer_data.c_name", customer2: "$customer_pairs.customer_data.c_name", spending_difference: 1 } }, { $sort: { spending_difference: 1 } }])
db.lineitem_orders.aggregate([{ $match: { o_totalprice: { $gt: 50000 } } }, { $out: "high_value_orders" }])
db.lineitem_orders.aggregate([{ $group: { _id: "$o_custkey", total_orders: { $sum: 1 }, mean_price: { $avg: "$o_totalprice" }, order_prices: { $push: "$o_totalprice" } } }, { $addFields: { variance: { $avg: { $map: { input: "$order_prices", as: "price", in: { $pow: [{ $subtract: ["$$price", "$mean_price"] }, 2] } } } } } }, { $addFields: { stddev_price: { $sqrt: "$variance" } } }, { $addFields: { variation_coefficient: { $cond: { if: { $eq: ["$mean_price", 0] }, then: null, else: { $divide: ["$stddev_price", "$mean_price"] } } } } }, { $lookup: { from: "customer", localField: "_id", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $project: { _id: 0, c_name: "$customer_data.c_name", variation_coefficient: 1 } }, { $sort: { variation_coefficient: -1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_totalprice: 1 } }], as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", pipeline: [{ $project: { _id: 0, "nation.n_name": 1 } }], as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $facet: { market_nation_sales: [{ $group: { _id: { market_segment: "$c_mktsegment", nation: "$nation_data.nation.n_name" }, total_sales: { $sum: "$orders.o_totalprice" } } }], market_sales: [{ $group: { _id: { market_segment: "$c_mktsegment" }, total_sales: { $sum: "$orders.o_totalprice" } } }], total_sales: [{ $group: { _id: null, total_sales: { $sum: "$orders.o_totalprice" } } }] } }, { $project: { results: { $concatArrays: ["$market_nation_sales", "$market_sales", "$total_sales"] } } }, { $unwind: "$results" }, { $match: { "results.total_sales": { $gt: 100000 } } }, { $project: { _id: 0, c_mktsegment: "$results._id.market_segment", n_name: "$results._id.nation", total_sales: "$results.total_sales" } }, { $sort: { c_mktsegment: 1, n_name: 1 } }])
db.lineitem_orders.aggregate([{ $lookup: { from: "lineitem", localField: "o_orderkey", foreignField: "l_orderkey", pipeline: [{ $project: { _id: 0, l_orderkey: 1, l_partkey: 1, l_extendedprice: 1 } }], as: "order_items" } }, { $unwind: "$order_items" }, { $group: { _id: { orderkey: "$o_orderkey" }, max_price: { $max: "$order_items.l_extendedprice" }, partkey: { $first: "$order_items.l_partkey" } } }, { $lookup: { from: "partsupp_part", localField: "partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1 } }], as: "part_data" } }, { $unwind: "$part_data" }, { $project: { _id: 0, o_orderkey: "$_id.orderkey", p_name: "$part_data.p_name", max_price: 1 } }, { $sort: { o_orderkey: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_orderkey: 1 } }], as: "orders" } }, { $project: { _id: 0, c_name: 1, order_ids: "$orders.o_orderkey" } }, { $sort: { c_name: 1 } }])
db.lineitem.aggregate([{ $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1 } }], as: "part_data" } }, { $unwind: "$part_data" }, { $group: { _id: "$part_data.p_name", total_sales: { $sum: "$l_extendedprice" } } }, { $setWindowFields: { partitionBy: null, sortBy: {}, output: { total_sales_all: { $sum: "$total_sales" } } } }, { $addFields: { percentage_of_total: { $multiply: [{ $divide: ["$total_sales", "$total_sales_all"] }, 100] } } }, { $project: { _id: 0, p_name: "$_id", total_sales: 1, percentage_of_total: { $round: ["$percentage_of_total", 2] } } }, { $sort: { total_sales: -1 } }])
db.lineitem_orders.aggregate([{ $lookup: { from: "customer", localField: "o_custkey", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $setWindowFields: { partitionBy: "$o_custkey", sortBy: { order_date: 1 }, output: { prev_order_date: { $shift: { by: -1, output: "$order_date" } } } } }, { $match: { prev_order_date: { $ne: null } } }, { $addFields: { days_between_orders: { $divide: [{ $subtract: ["$order_date", "$prev_order_date"] }, 1000 * 60 * 60 * 24] } } }, { $group: { _id: "$customer_data.c_name", avg_days_between_orders: { $avg: "$days_between_orders" } } }, { $project: { _id: 0, c_name: "$_id", avg_days_between_orders: { $round: ["$avg_days_between_orders", 2] } } }, { $sort: { avg_days_between_orders: -1 } }])
db.lineitem.aggregate([{ $group: { _id: { order_id: "$l_orderkey", part_id: "$l_partkey" }, part_count: { $sum: 1 } } }, { $group: { _id: "$_id.part_id", orders: { $addToSet: "$_id.order_id" } } }, { $project: { _id: 0, order_pairs: { $filter: { input: { $map: { input: "$orders", as: "order1", in: { order1: "$$order1", orders: "$orders" } } }, as: "pair", cond: { $lt: ["$$pair.order1", "$$pair.orders"] } } } } }, { $unwind: "$order_pairs" }, { $unwind: "$order_pairs.orders" }, { $match: { $expr: { $lt: ["$order_pairs.order1", "$order_pairs.orders"] } } }, { $group: { _id: { order1: "$order_pairs.order1", order2: "$order_pairs.orders" }, common_parts: { $sum: 1 } } }, { $lookup: { from: "lineitem", localField: "_id.order1", foreignField: "l_orderkey", pipeline: [{ $count: "total_items" }], as: "order1_total" } }, { $unwind: "$order1_total" }, { $addFields: { similarity_percentage: { $multiply: [{ $divide: ["$common_parts", "$order1_total.total_items"] }, 100] } } }, { $match: { similarity_percentage: { $gt: 80 } } }, { $project: { _id: 0, order1: "$_id.order1", order2: "$_id.order2", similarity_percentage: { $round: ["$similarity_percentage", 2] } } }, { $sort: { similarity_percentage: -1 } }, { $limit: 50 }])
db.part.aggregate([{ $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "orders", localField: "lineitems.l_orderkey", foreignField: "o_orderkey", as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "customer", localField: "orders.o_custkey", foreignField: "c_custkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "nation_region", localField: "customers.c_nationkey", foreignField: "nation.n_nationkey", as: "nations" } }, { $unwind: "$nations" }, { $project: { p_name: 1, nation_name: "$nations.n_name", _id: 0 } }, { $group: { _id: { p_name: "$p_name", nation_name: "$nation_name" }, count: { $sum: 1 } } }, { $match: { count: { $eq: 1 } } }, { $project: { p_name: "$_id.p_name", nation_name: "$_id.nation_name", _id: 0 } }])
db.lineitem.aggregate([{ $project: { _id: 0, l_orderkey: 1, l_extendedprice: 1, l_quantity: 1, l_partkey: 1, l_suppkey: 1 } }, { $group: { _id: "$l_orderkey", revenue: { $sum: "$l_extendedprice" }, items: { $push: { part: "$l_partkey", supplier: "$l_suppkey", qty: "$l_quantity" } } } }, { $lookup: { from: "partsupp", let: { parts: "$items" }, pipeline: [{ $match: { $expr: { $in: ["$ps_partkey", "$$parts.part"] } } }, { $project: { _id: 0, ps_partkey: 1, ps_suppkey: 1, ps_supplycost: 1 } }], as: "partsupp_data" } }, { $addFields: { total_cost: { $reduce: { input: "$items", initialValue: 0, in: { $add: ["$$value", { $sum: { $map: { input: "$partsupp_data", as: "ps", in: { $cond: { if: { $and: [ { $eq: ["$$ps.ps_partkey", "$$this.part"] }, { $eq: ["$$ps.ps_suppkey", "$$this.supplier"] } ] }, then: { $multiply: ["$$this.qty", "$$ps.ps_supplycost"] }, else: 0 } } } } ] } } } } } }, { $addFields: { profit: { $subtract: ["$revenue", "$total_cost"] } } }, { $project: { _id: 0, o_orderkey: "$_id", revenue: 1, total_cost: 1, profit: 1 } }, { $sort: { revenue: -1 } }, { $limit: 100 }])
db.lineitem.aggregate([{ $project: { _id: 0, l_orderkey: 1, l_extendedprice: 1, l_quantity: 1, l_partkey: 1, l_suppkey: 1 } }, { $group: { _id: "$l_orderkey", revenue: { $sum: "$l_extendedprice" }, items: { $push: { part: "$l_partkey", supplier: "$l_suppkey", qty: "$l_quantity" } } } }, { $lookup: { from: "partsupp", let: { parts: "$items" }, pipeline: [ { $match: { $expr: { $in: ["$ps_partkey", "$$parts.part"] } } }, { $project: { _id: 0, ps_partkey: 1, ps_suppkey: 1, ps_supplycost: 1 } } ], as: "partsupp_data" } }, { $addFields: { total_cost: { $reduce: { input: "$items", initialValue: 0, in: { $add: ["$$value", { $sum: { $map: { input: "$partsupp_data", as: "ps", in: { $cond: { if: { $and: [ { $eq: ["$$ps.ps_partkey", "$$this.part"] }, { $eq: ["$$ps.ps_suppkey", "$$this.supplier"] } ] }, then: { $multiply: ["$$this.qty", "$$ps.ps_supplycost"] }, else: 0 } } } } ] } } } } } }, { $addFields: { profit: { $subtract: ["$revenue", "$total_cost"] } } }, { $project: { _id: 0, o_orderkey: "$_id", revenue: 1, total_cost: 1, profit: 1 } }, { $sort: { revenue: -1 } }, { $limit: 100 }])
db.supplier.aggregate([{ $lookup: { from: "lineitem", localField: "s_suppkey", foreignField: "l_suppkey", as: "lineitem_data" } }, { $unwind: { path: "$lineitem_data", preserveNullAndEmptyArrays: true } }, { $lookup: { from: "lineitem_orders", localField: "lineitem_data.l_orderkey", foreignField: "o_orderkey", as: "order_data" } }, { $unwind: { path: "$order_data", preserveNullAndEmptyArrays: true } }, { $addFields: { order_date: { $cond: { if: { $eq: [{ $type: "$order_data.o_orderdate" }, "string"] }, then: { $dateFromString: { dateString: "$order_data.o_orderdate" } }, else: "$order_data.o_orderdate" } } } }, { $group: { _id: "$s_suppkey", s_name: { $first: "$s_name" }, latest_order_date: { $max: "$order_date" } } }, { $match: { $or: [ { latest_order_date: null }, { latest_order_date: { $lt: new Date(new Date().setFullYear(new Date().getFullYear() - 1)) } } ] } }, { $project: { _id: 0, s_name: 1 } }, { $sort: { s_name: 1 } }, { $limit: 100 } ])
db.lineitem_orders.aggregate([{ $group: { _id: { custkey: "$o_custkey", order_year: { $year: { $dateFromString: { dateString: "$o_orderdate" } } } }, total_orders: { $sum: 1 } } }, { $lookup: { from: "lineitem_orders", let: { custKey: "$_id.custkey", orderYear: "$_id.order_year" }, pipeline: [{ $match: { $expr: { $and: [{ $eq: ["$o_custkey", "$$custKey"] }, { $eq: [{ $year: { $dateFromString: { dateString: "$o_orderdate" } } }, { $subtract: ["$$orderYear", 1] }] } ] } } }, { $group: { _id: "$o_custkey", prev_total_orders: { $sum: 1 } } } ], as: "previous_year" } }, { $unwind: { path: "$previous_year", preserveNullAndEmptyArrays: true } }, { $lookup: { from: "customer", localField: "_id.custkey", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_custkey: 1, c_name: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $addFields: { previous_orders: { $ifNull: ["$previous_year.prev_total_orders", 0] }, change_percentage: { $cond: { if: { $gt: ["$previous_year.prev_total_orders", 0] }, then: { $multiply: [{ $divide: [{ $subtract: ["$total_orders", "$previous_year.prev_total_orders"] }, "$previous_year.prev_total_orders"] }, 100] }, else: null } } } }, { $match: { change_percentage: { $gt: 30 } } }, { $project: { _id: 0, c_name: "$customer_data.c_name", current_year_orders: "$total_orders", previous_year_orders: "$previous_year.prev_total_orders", change_percentage: 1 } }, { $sort: { change_percentage: -1 } }, { $limit: 100 } ])
db.customer.aggregate([{ $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", pipeline: [{ $unwind: "$nation" }], as: "nation_data" } }, { $unwind: "$nation_data" }, { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $facet: { segment_nation: [{ $group: { _id: { mktsegment: "$c_mktsegment", nation: "$nation_data.nation.n_name" }, total_sales: { $sum: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_mktsegment: "$_id.mktsegment", n_name: "$_id.nation", total_sales: 1 } } ] }, segment_total: [{ $group: { _id: "$c_mktsegment", total_sales: { $sum: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_mktsegment: "$_id", n_name: null, total_sales: 1 } } ], grand_total: [{ $group: { _id: null, total_sales: { $sum: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_mktsegment: null, n_name: null, total_sales: 1 } } ] } }, { $project: { results: { $concatArrays: ["$segment_nation", "$segment_total", "$grand_total"] } } }, { $unwind: "$results" }, { $replaceRoot: { newRoot: "$results" } }, { $sort: { c_mktsegment: 1, n_name: 1 } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_orderkey: 1 } }], as: "orders" } }, { $unwind: "$orders" }, { $lookup: { from: "lineitem", localField: "orders.o_orderkey", foreignField: "l_orderkey", pipeline: [{ $project: { _id: 0, l_partkey: 1, l_quantity: 1 } }], as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "partsupp_part", localField: "lineitems.l_partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1 } }], as: "part_data" } }, { $unwind: "$part_data" }, { $group: { _id: { mktsegment: "$c_mktsegment", product: "$part_data.p_name" }, total_sold: { $sum: "$lineitems.l_quantity" } } }, { $project: { _id: 0, c_mktsegment: "$_id.mktsegment", p_name: "$_id.product", total_sold: 1 } }, { $sort: { c_mktsegment: 1, total_sold: -1 } }, { $group: { _id: "$c_mktsegment", products: { $push: "$$ROOT" } } }, { $project: { _id: 0, c_mktsegment: "$_id", products: { $slice: ["$products", 5] } } }, { $unwind: "$products" }, { $replaceRoot: { newRoot: "$products" } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $sort: { o_totalprice: -1 } }, { $limit: 1 }, { $project: { _id: 0, o_orderkey: 1, o_totalprice: 1 } }], as: "highest_order" } }, { $unwind: "$highest_order" }, { $project: { _id: 0, c_name: 1, o_orderkey: "$highest_order.o_orderkey", o_totalprice: "$highest_order.o_totalprice" } }, { $sort: { o_totalprice: -1 } }])
db.lineitem_orders.aggregate([{ $lookup: { from: "customer", localField: "o_custkey", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_nationkey: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $group: { _id: { nation_key: "$customer_data.c_nationkey", order_year: { $year: { $dateFromString: { dateString: "$o_orderdate" } } } }, total_sales: { $sum: "$o_totalprice" } } }, { $lookup: { from: "nation_region", localField: "_id.nation_key", foreignField: "nation.n_nationkey", pipeline: [{ $unwind: "$nation" }, { $project: { _id: 0, n_name: "$nation.n_name" } }], as: "nation_data" } }, { $unwind: "$nation_data" }, { $lookup: { from: "lineitem_orders", let: { nationKey: "$_id.nation_key", orderYear: "$_id.order_year" }, pipeline: [{ $lookup: { from: "customer", localField: "o_custkey", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_nationkey: 1 } }], as: "customer_data" } }, { $unwind: "$customer_data" }, { $match: { $expr: { $and: [{ $eq: ["$customer_data.c_nationkey", "$$nationKey"] }, { $eq: [{ $year: { $dateFromString: { dateString: "$o_orderdate" } } }, { $subtract: ["$$orderYear", 1] }] } ] } } }, { $group: { _id: null, prev_total_sales: { $sum: "$o_totalprice" } } } ], as: "previous_year" } }, { $unwind: { path: "$previous_year", preserveNullAndEmptyArrays: true } }, { $addFields: { prev_year_sales: { $ifNull: ["$previous_year.prev_total_sales", 0] }, growth_percentage: { $cond: { if: { $gt: ["$previous_year.prev_total_sales", 0] }, then: { $multiply: [{ $divide: [{ $subtract: ["$total_sales", "$previous_year.prev_total_sales"] }, "$previous_year.prev_total_sales"] }, 100] }, else: null } } } }, { $project: { _id: 0, nation: "$nation_data.n_name", order_year: "$_id.order_year", total_sales: 1, prev_year_sales: 1, growth_percentage: 1 } }, { $sort: { nation: 1, order_year: 1 } }, { $limit: 100 } ])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_orderdate: { $dateFromString: { dateString: "$o_orderdate" } } } }], as: "orders" } }, { $addFields: { last_order_date: { $max: "$orders.o_orderdate" } } }, { $match: { last_order_date: { $lt: new Date(new Date().setFullYear(new Date().getFullYear() - 1)) } } }, { $project: { _id: 0, c_name: 1, last_order_date: 1 } }, { $sort: { last_order_date: 1 } }, { $limit: 100 }])
db.lineitem_orders.aggregate([{ $lookup: { from: "lineitem", localField: "o_orderkey", foreignField: "l_orderkey", pipeline: [{ $project: { _id: 0, l_partkey: 1, l_quantity: 1 } }], as: "lineitems" } }, { $unwind: "$lineitems" }, { $group: { _id: { sales_month: { $dateToString: { format: "%Y-%m", date: { $dateFromString: { dateString: "$o_orderdate" } } } }, l_partkey: "$lineitems.l_partkey" }, total_quantity: { $sum: "$lineitems.l_quantity" } } }, { $lookup: { from: "partsupp_part", localField: "_id.l_partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1 } }], as: "part_data" } }, { $unwind: "$part_data" }, { $group: { _id: "$_id.sales_month", top_product: { $first: "$part_data.p_name" }, total_quantity: { $first: "$total_quantity" } } }, { $project: { _id: 0, sales_month: "$_id", p_name: "$top_product", total_quantity: 1 } }, { $sort: { sales_month: 1 } }, { $limit: 100 }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $group: { _id: "$o_custkey", total_spent: { $sum: "$o_totalprice" } } }], as: "order_summary" } }, { $unwind: { path: "$order_summary", preserveNullAndEmptyArrays: true } }, { $addFields: { total_spent: { $ifNull: ["$order_summary.total_spent", 0] }, customer_category: { $switch: { branches: [{ case: { $gt: ["$order_summary.total_spent", 100000] }, then: "High Value" }, { case: { $and: [{ $gte: ["$order_summary.total_spent", 50000] }, { $lte: ["$order_summary.total_spent", 100000] }] }, then: "Medium Value" } ], default: "Low Value" } } } }, { $project: { _id: 0, c_name: 1, customer_category: 1, total_spent: 1 } }, { $sort: { total_spent: -1 } }, { $limit: 100 }])
db.lineitem.aggregate([{ $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", pipeline: [{ $project: { _id: 0, o_custkey: 1, o_orderkey: 1 } }], as: "order_info" } }, { $unwind: "$order_info" }, { $lookup: { from: "customer", localField: "order_info.o_custkey", foreignField: "c_custkey", pipeline: [{ $project: { _id: 0, c_name: 1, c_custkey: 1 } }], as: "customer_info" } }, { $unwind: "$customer_info" }, { $group: { _id: "$l_partkey", customers: { $addToSet: "$customer_info.c_name" } } }, { $match: { "customers.1": { $exists: true } } }, { $project: { _id: 0, l_partkey: "$_id", customer_pairs: { $filter: { input: { $zip: { inputs: ["$customers", { $reverseArray: "$customers" }] } }, as: "pair", cond: { $lt: [{ $arrayElemAt: ["$$pair", 0] }, { $arrayElemAt: ["$$pair", 1] }] } } } } }, { $unwind: "$customer_pairs" }, { $project: { customer1: { $arrayElemAt: ["$customer_pairs", 0] }, customer2: { $arrayElemAt: ["$customer_pairs", 1] }, l_partkey: 1 } }, { $sort: { customer1: 1, customer2: 1 } }, { $limit: 100 } ])
db.lineitem_orders.aggregate([{ $group: { _id: { sales_month: { $dateToString: { format: "%Y-%m", date: { $dateFromString: { dateString: "$o_orderdate" } } } } }, total_sales: { $sum: "$o_totalprice" } } }, { $sort: { "_id.sales_month": 1 } }, { $setWindowFields: { partitionBy: null, sortBy: { "_id.sales_month": 1 }, output: { moving_avg: { $avg: "$total_sales", window: { documents: [-2, 0] } } } } }, { $project: { _id: 0, sales_month: "$_id.sales_month", total_sales: 1, moving_avg: 1 } }, { $limit: 100 }])
db.supplier.aggregate([{ $lookup: { from: "partsupp", localField: "s_suppkey", foreignField: "ps_suppkey", as: "partsupp_data" } }, { $unwind: "$partsupp_data" }, { $lookup: { from: "lineitem", localField: "partsupp_data.ps_partkey", foreignField: "l_partkey", as: "lineitem_data" } }, { $unwind: "$lineitem_data" }, { $group: { _id: "$s_name", total_profit: { $sum: { $subtract: ["$lineitem_data.l_extendedprice", { $multiply: ["$partsupp_data.ps_supplycost", "$lineitem_data.l_quantity"] }] } } } }, { $sort: { total_profit: -1 } }, { $limit: 10 }, { $project: { _id: 0, s_name: "$_id", total_profit: 1 } }])
db.lineitem.aggregate([{ $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", pipeline: [{ $project: { _id: 0, o_orderdate: { $dateFromString: { dateString: "$o_orderdate" } } } }], as: "order_data" } }, { $unwind: "$order_data" }, { $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_name: 1, p_partkey: 1 } }], as: "part_data" } }, { $unwind: "$part_data" }, { $group: { _id: { sales_month: { $dateToString: { format: "%Y-%m", date: "$order_data.o_orderdate" } }, p_partkey: "$part_data.p_partkey", p_name: "$part_data.p_name" }, total_sales: { $sum: "$l_extendedprice" } } }, { $sort: { "_id.p_partkey": 1, "_id.sales_month": 1 } }, { $setWindowFields: { partitionBy: "$_id.p_partkey", sortBy: { "_id.sales_month": 1 }, output: { prev_month_sales: { $shift: { by: -1, output: "$total_sales" } } } } }, { $project: { _id: 0, p_name: "$_id.p_name", sales_month: "$_id.sales_month", total_sales: 1, variation_percentage: { $cond: { if: { $eq: ["$prev_month_sales", null] }, then: null, else: { $multiply: [{ $divide: [{ $subtract: ["$total_sales", "$prev_month_sales"] }, "$prev_month_sales"] }, 100] } } } } } }, { $limit: 100 }])
db.supplier.aggregate([{ $lookup: { from: "partsupp", localField: "s_suppkey", foreignField: "ps_suppkey", pipeline: [{ $project: { _id: 0, ps_partkey: 1 } }], as: "supplied_parts" } }, { $project: { s_name: 1, unique_products: { $size: { $setUnion: ["$supplied_parts.ps_partkey"] } } } }, { $sort: { unique_products: -1 } }, { $limit: 10 }])
db.lineitem_orders.aggregate([{ $project: { _id: 0, order_month: { $month: { $dateFromString: { dateString: "$o_orderdate" } } } } }, { $addFields: { season: { $switch: { branches: [ { case: { $in: ["$order_month", [3, 4, 5]] }, then: "Spring" }, { case: { $in: ["$order_month", [6, 7, 8]] }, then: "Summer" }, { case: { $in: ["$order_month", [9, 10, 11]] }, then: "Autumn" } ], default: "Winter" } } } }, { $group: { _id: "$season", total_orders: { $sum: 1 } } }, { $sort: { total_orders: -1 } }])
db.partsupp_part.aggregate([{ $project: { _id: 0, p_name: 1, p_retailprice: 1, price_category: { $switch: { branches: [ { case: { $gt: ["$p_retailprice", 1000] }, then: "Expensive" }, { case: { $gt: ["$p_retailprice", 500] }, then: "Medium" } ], default: "Cheap" } } } } }])
db.lineitem_orders.aggregate([{ $unwind: "$lineitem" }, { $project: { _id: 0, order_date: { $dateFromString: { dateString: "$o_orderdate" } }, ship_date: { $dateFromString: { dateString: "$lineitem.l_shipdate" } } } }, { $project: { delivery_days: { $dateDiff: { startDate: "$order_date", endDate: "$ship_date", unit: "day" } } } }, { $group: { _id: null, avg_delivery_days: { $avg: "$delivery_days" } } }])
db.supplier.aggregate([{ $lookup: { from: "partsupp", localField: "s_suppkey", foreignField: "ps_suppkey", pipeline: [{ $project: { _id: 0, ps_supplycost: 1 } }], as: "supplied_parts" } }, { $project: { s_name: 1, avg_supply_cost: { $avg: "$supplied_parts.ps_supplycost" } } }, { $sort: { avg_supply_cost: -1 } }, { $limit: 10 }])
db.lineitem.aggregate([{ $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $group: { _id: "$part_info.p_name", total_sales: { $sum: "$l_extendedprice" } } }, { $group: { _id: null, products: { $push: { p_name: "$_id", total_sales: "$total_sales" } }, total_market_sales: { $sum: "$total_sales" } } }, { $unwind: "$products" }, { $project: { _id: 0, p_name: "$products.p_name", total_sales: "$products.total_sales", sales_percentage: { $multiply: [{ $divide: ["$products.total_sales", "$total_market_sales"] }, 100] } } }, { $sort: { total_sales: -1 } }, { $limit: 10 }])
db.lineitem_orders.aggregate([{ $group: { _id: { $year: { $dateFromString: { dateString: "$o_orderdate" } } }, total_sales: { $sum: "$o_totalprice" } } }, { $sort: { "_id": 1 } }, { $setWindowFields: { partitionBy: null, sortBy: { "_id": 1 }, output: { prev_year_sales: { $shift: { by: -1, output: "$total_sales" } } } } }, { $project: { _id: 0, order_year: "$_id", total_sales: 1, growth_rate: { $cond: { if: { $eq: ["$prev_year_sales", 0] }, then: null, else: { $multiply: [{ $divide: [{ $subtract: ["$total_sales", "$prev_year_sales"] }, "$prev_year_sales"] }, 100] } } } } } }])
db.customer.aggregate([{ $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_totalprice: 1 } }], as: "orders" } }, { $project: { c_name: 1, total_spent: { $sum: "$orders.o_totalprice" } } }, { $sort: { total_spent: -1 } }, { $limit: 10 }])
db.lineitem_orders.aggregate([{ $group: { _id: { $dateToString: { format: "%Y-%m", date: { $dateFromString: { dateString: "$o_orderdate" } } } }, total_sales: { $sum: "$o_totalprice" } } }, { $sort: { "_id": 1 } }, { $setWindowFields: { partitionBy: null, sortBy: { "_id": 1 }, output: { moving_avg: { $avg: "$total_sales", window: { documents: [-2, 0] } } } } }, { $project: { _id: 0, sales_month: "$_id", total_sales: 1, moving_avg: 1 } } ])
db.lineitem.aggregate([{ $match: { l_returnflag: "R" } }, { $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $group: { _id: "$part_info.p_name", return_count: { $sum: 1 } } }, { $sort: { return_count: -1 } }, { $limit: 10 }, { $project: { _id: 0, p_name: "$_id", return_count: 1 } } ])
db.partsupp.aggregate([{ $lookup: { from: "supplier", localField: "ps_suppkey", foreignField: "s_suppkey", as: "supplier_info" } }, { $unwind: "$supplier_info" }, { $lookup: { from: "partsupp_part", localField: "ps_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $project: { _id: 0, s_name: "$supplier_info.s_name", p_name: "$part_info.p_name", ps_supplycost: 1 } }, { $sort: { ps_supplycost: 1 } }, { $limit: 10 } ])
db.lineitem.aggregate([{ $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", as: "order_info" } }, { $unwind: "$order_info" }, { $lookup: { from: "partsupp", localField: "l_partkey", foreignField: "ps_partkey", as: "partsupp_info" } }, { $unwind: "$partsupp_info" }, { $lookup: { from: "supplier", localField: "partsupp_info.ps_suppkey", foreignField: "s_suppkey", as: "supplier_info" } }, { $unwind: "$supplier_info" }, { $addFields: { order_year: { $substr: ["$order_info.o_orderdate", 0, 4] } } }, { $group: { _id: { s_name: "$supplier_info.s_name", order_year: "$order_year" }, total_orders: { $addToSet: "$l_orderkey" } } }, { $project: { _id: 0, s_name: "$_id.s_name", order_year: { $toInt: "$_id.order_year" }, total_orders: { $size: "$total_orders" } } }, { $sort: { s_name: 1, order_year: 1 } }, { $setWindowFields: { partitionBy: "$s_name", sortBy: { order_year: 1 }, output: { prev_total_orders: { $shift: { output: "$total_orders", by: -1 } } } } }, { $addFields: { growth_rate: { $cond: { if: { $eq: ["$prev_total_orders", null] }, then: null, else: { $multiply: [{ $divide: [{ $subtract: ["$total_orders", "$prev_total_orders"] }, "$prev_total_orders"] }, 100] } } } } }, { $match: { growth_rate: { $ne: null } } }, { $sort: { s_name: 1, order_year: 1 } } ])
db.lineitem.aggregate([{ $lookup: { from: "lineitem_orders", localField: "l_orderkey", foreignField: "o_orderkey", as: "order_info" } }, { $unwind: "$order_info" }, { $lookup: { from: "customer", localField: "order_info.o_custkey", foreignField: "c_custkey", as: "customer_info" } }, { $unwind: "$customer_info" }, { $lookup: { from: "nation_region", localField: "customer_info.c_nationkey", foreignField: "nation.n_nationkey", as: "nation_info" } }, { $unwind: "$nation_info" }, { $unwind: "$nation_info.nation" }, { $project: { _id: 0, l_partkey: 1, r_name: "$nation_info.r_name" } }, { $group: { _id: "$l_partkey", region_count: { $addToSet: "$r_name" } } }, { $match: { $expr: { $eq: [{ $size: "$region_count" }, totalRegions] } } }, { $lookup: { from: "partsupp_part", localField: "_id", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $project: { _id: 0, p_name: "$part_info.p_name" } }, { $limit: 20 }])
db.lineitem.aggregate([{ $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $project: { _id: 0, p_name: "$part_info.p_name", unit_price: { $cond: { if: { $gt: ["$l_quantity", 0] }, then: { $divide: ["$l_extendedprice", "$l_quantity"] }, else: 0 } } } }, { $group: { _id: "$p_name", min_price: { $min: "$unit_price" }, max_price: { $max: "$unit_price" } } }, { $project: { _id: 0, p_name: "$_id", min_price: 1, max_price: 1, price_variation: { $subtract: ["$max_price", "$min_price"] } } }, { $sort: { price_variation: -1 } }, { $limit: 10 }])
db.partsupp_part.aggregate([{ $lookup: { from: "supplier", localField: "partsupp.ps_suppkey", foreignField: "s_suppkey", pipeline: [{ $project: { _id: 0, s_name: 1 } }], as: "supplier_info" } }, { $unwind: "$supplier_info" }, { $group: { _id: "$p_name", num_suppliers: { $addToSet: "$supplier_info.s_name" } } }, { $project: { p_name: "$_id", num_suppliers: { $size: "$num_suppliers" } } }, { $match: { num_suppliers: { $gte: 4 } } }, { $sort: { num_suppliers: -1 } }])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_custkey: 1, o_totalprice: 1 } }], as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_name", total_spent: { $sum: "$orders.o_totalprice" } } }, { $sort: { total_spent: -1 } }, { $limit: 5 }, { $project: { _id: 0, c_name: "$_id", total_spent: 1 } } ])
var avgTotalPrice = db.lineitem_orders.aggregate([{ $group: { _id: null, avg_price: { $avg: "$o_totalprice" } } }]).toArray()[0].avg_price; db.lineitem_orders.aggregate([{ $match: { o_totalprice: { $gt: avgTotalPrice } } }, { $project: { _id: 0, o_orderkey: 1, o_totalprice: 1 } }, { $sort: { o_totalprice: -1 } }])
db.nation_region.aggregate([{ $unwind: "$nation" }, { $lookup: { from: "supplier", localField: "nation.n_nationkey", foreignField: "s_nationkey", pipeline: [{ $project: { _id: 0, s_suppkey: 1 } }], as: "suppliers" } }, { $unwind: "$suppliers" }, { $lookup: { from: "partsupp_part", localField: "suppliers.s_suppkey", foreignField: "partsupp.ps_suppkey", pipeline: [{ $project: { _id: 0, "partsupp.ps_partkey": 1 } }], as: "partsupp_data" } }, { $unwind: "$partsupp_data" }, { $lookup: { from: "partsupp_part", localField: "partsupp_data.partsupp.ps_partkey", foreignField: "p_partkey", pipeline: [{ $project: { _id: 0, p_partkey: 1, p_retailprice: 1 } }], as: "part_info" } }, { $unwind: "$part_info" }, { $group: { _id: "$nation.n_name", avg_retail_price: { $avg: "$part_info.p_retailprice" } } }, { $project: { _id: 0, n_name: "$_id", avg_retail_price: { $round: ["$avg_retail_price", 2] } } }, { $sort: { avg_retail_price: -1 } }])
db.lineitem_orders.aggregate([{ $unwind: "$lineitem" }, { $match: { $expr: { $gt: ["$lineitem.l_shipdate", "$o_orderdate"] } } }, { $project: { _id: 0, o_orderkey: 1, l_shipdate: "$lineitem.l_shipdate", o_orderdate: 1 } }, { $sort: { o_orderdate: 1 } }])
var maxAcctBal = db.supplier.aggregate([{ $group: { _id: null, max_balance: { $max: "$s_acctbal" } } }]).toArray()[0].max_balance; db.supplier.aggregate([{ $match: { s_acctbal: maxAcctBal } }, { $project: { _id: 0, s_name: 1, s_acctbal: 1 } }])
db.nation_region.aggregate([ { $unwind: "$nation" }, { $match: { "nation.n_name": "FRANCE" } }, { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", pipeline: [{ $project: { _id: 0, c_custkey: 1, c_name: 1 } }], as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", pipeline: [{ $project: { _id: 0, o_orderkey: 1, o_custkey: 1 } }], as: "orders" } }, { $unwind: "$orders" }, { $project: { _id: 0, o_orderkey: "$orders.o_orderkey", c_name: "$customers.c_name" } }, { $sort: { c_name: 1, o_orderkey: 1 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $match: { "lineitem.l_discount": { $gte: 0.10 } } }, { $project: { _id: 0, o_orderkey: 1, l_discount: "$lineitem.l_discount" } }, { $sort: { o_orderkey: 1 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $group: { _id: "$o_orderkey", num_products: { $addToSet: "$lineitem.l_partkey" } } }, { $match: { "num_products.3": { $exists: true } } }, { $project: { _id: 0, o_orderkey: "$_id", num_products: { $size: "$num_products" } } }, { $sort: { o_orderkey: 1 } } ])
var avgSupplyCost = db.partsupp.aggregate([ { $group: { _id: null, avg_supplycost: { $avg: "$ps_supplycost" } } } ]).toArray()[0].avg_supplycost; db.partsupp.aggregate([ { $match: { ps_supplycost: { $gt: avgSupplyCost } } }, { $lookup: { from: "supplier", localField: "ps_suppkey", foreignField: "s_suppkey", as: "supplier_info" } }, { $unwind: "$supplier_info" }, { $project: { _id: 0, s_name: "$supplier_info.s_name", ps_supplycost: 1 } }, { $sort: { ps_supplycost: -1 } } ])
db.partsupp_part.aggregate([ { $lookup: { from: "partsupp", localField: "p_partkey", foreignField: "ps_partkey", as: "partsupp_data" } }, { $unwind: "$partsupp_data" }, { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitem_data" } }, { $unwind: "$lineitem_data" }, { $group: { _id: "$p_name", total_profit: { $sum: { $subtract: [ "$lineitem_data.l_extendedprice", { $multiply: ["$lineitem_data.l_quantity", "$partsupp_data.ps_supplycost"] } ] } } } }, { $sort: { total_profit: -1 } }, { $limit: 10 } ])
db.lineitem_orders.aggregate([ { $set: { order_year: { $year: { $toDate: "$o_orderdate" } }, order_month: { $month: { $toDate: "$o_orderdate" } } } }, { $sort: { order_year: 1, order_month: 1, o_totalprice: -1 } }, { $group: { _id: { year: "$order_year", month: "$order_month" }, top_orders: { $push: { order_id: "$o_orderkey", total_price: "$o_totalprice" } } } }, { $project: { _id: 0, order_month: { $concat: [{ $toString: "$_id.year" }, "-", { $toString: "$_id.month" }] }, top_orders: { $slice: ["$top_orders", 5] } } }, { $unwind: "$top_orders" }, { $project: { order_month: 1, o_orderkey: "$top_orders.order_id", o_totalprice: "$top_orders.total_price" } } ])
db.supplier.aggregate([ { $lookup: { from: "nation_region", localField: "s_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: "$nation_data.nation.n_name", total_suppliers: { $sum: 1 } } }, { $sort: { total_suppliers: -1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: { c_mktsegment: "$c_mktsegment", c_name: "$c_name" }, max_order: { $max: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_mktsegment: "$_id.c_mktsegment", c_name: "$_id.c_name", max_order: 1 } } ])
db.lineitem_orders.aggregate([ { $lookup: { from: "lineitem", localField: "o_orderkey", foreignField: "l_orderkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $addFields: { order_date: { $dateFromString: { dateString: "$o_orderdate" } }, ship_date: { $dateFromString: { dateString: "$lineitems.l_shipdate" } } } }, { $match: { $expr: { $gt: [ { $subtract: ["$ship_date", "$order_date"] }, 1209600000 ] } } }, { $project: { _id: 0, o_orderkey: 1, l_shipdate: "$lineitems.l_shipdate", o_orderdate: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_name", max_order_value: { $max: "$orders.o_totalprice" } } }, { $project: { _id: 0, c_name: "$_id", max_order_value: 1 } }, { $sort: { max_order_value: -1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [ { $group: { _id: "$o_custkey", total_orders: { $sum: 1 } } } ], as: "orders" } }, { $unwind: { path: "$orders", preserveNullAndEmptyArrays: true } }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: { nation: "$nation_data.nation.n_name", customer: "$c_name" }, total_orders: { $sum: "$orders.total_orders" } } }, { $sort: { "_id.nation": 1, total_orders: -1 } }, { $group: { _id: "$_id.nation", top_customers: { $push: { customer: "$_id.customer", total_orders: "$total_orders" } } } }, { $project: { _id: 0, nation: "$_id", top_customers: { $slice: ["$top_customers", 3] } } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", pipeline: [ { $group: { _id: "$o_custkey", total_orders: { $sum: 1 } } } ], as: "orders" } }, { $unwind: { path: "$orders", preserveNullAndEmptyArrays: true } }, { $lookup: { from: "nation_region", localField: "c_nationkey", foreignField: "nation.n_nationkey", as: "nation_data" } }, { $unwind: "$nation_data" }, { $unwind: "$nation_data.nation" }, { $group: { _id: { nation: "$nation_data.nation.n_name", customer: "$c_name" }, total_orders: { $sum: "$orders.total_orders" } } }, { $sort: { "_id.nation": 1, total_orders: -1 } }, { $group: { _id: "$_id.nation", top_customers: { $push: { customer: "$_id.customer", total_orders: "$total_orders" } } } }, { $project: { _id: 0, nation: "$_id", top_customers: { $slice: ["$top_customers", 3] } } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $project: { order_month: { $concat: [ { $toString: { $year: { $dateFromString: { dateString: "$o_orderdate" } } } }, "-", { $toString: { $month: { $dateFromString: { dateString: "$o_orderdate" } } } } ] }, o_orderkey: 1, l_discount: "$lineitem.l_discount" } }, { $group: { _id: { order_month: "$order_month", o_orderkey: "$o_orderkey" }, max_discount: { $max: "$l_discount" } } }, { $sort: { "_id.order_month": 1, max_discount: -1 } }, { $project: { _id: 0, order_month: "$_id.order_month", o_orderkey: "$_id.o_orderkey", max_discount: 1 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $group: { _id: "$o_orderkey", unique_products: { $addToSet: "$lineitem.l_partkey" } } }, { $project: { _id: 0, o_orderkey: "$_id", unique_products: { $size: "$unique_products" } } }, { $sort: { unique_products: -1 } } ])
db.lineitem.aggregate([ { $lookup: { from: "lineitem", let: { orderkey: "$l_orderkey", partkey: "$l_partkey" }, pipeline: [ { $match: { $expr: { $and: [ { $eq: ["$l_orderkey", "$$orderkey"] }, { $gt: ["$l_partkey", "$$partkey"] } ] } } }, { $project: { l_partkey: 1 } } ], as: "matching_lineitems" } }, { $unwind: "$matching_lineitems" }, { $group: { _id: { product_1: "$l_partkey", product_2: "$matching_lineitems.l_partkey" }, total_orders: { $sum: 1 } } }, { $project: { product_1: "$_id.product_1", product_2: "$_id.product_2", total_orders: 1, _id: 0 } }, { $sort: { total_orders: -1 } }, { $limit: 10 } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $lookup: { from: "partsupp_part", localField: "lineitem.l_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $addFields: { orderDate: { $dateFromString: { dateString: "$o_orderdate" } } } }, { $project: { year: { $year: "$orderDate" }, month: { $month: "$orderDate" }, p_name: "$part_info.p_name", l_extendedprice: "$lineitem.l_extendedprice" } }, { $group: { _id: { year: "$year", month: "$month", p_name: "$p_name" }, max_price: { $max: "$l_extendedprice" } } }, { $project: { year: "$_id.year", month: "$_id.month", p_name: "$_id.p_name", max_price: 1, _id: 0 } }, { $sort: { year: -1, month: -1, max_price: -1 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $lookup: { from: "partsupp_part", localField: "lineitem.l_partkey", foreignField: "p_partkey", as: "part_info" } }, { $unwind: "$part_info" }, { $addFields: { orderDate: { $dateFromString: { dateString: "$o_orderdate" } } } }, { $group: { _id: null, maxOrderDate: { $max: "$orderDate" } } }, { $addFields: { threeMonthsAgo: { $dateSubtract: { startDate: "$maxOrderDate", unit: "month", amount: 3 } } } }, { $lookup: { from: "lineitem_orders", let: { threeMonthsAgo: "$threeMonthsAgo" }, pipeline: [ { $unwind: "$lineitem" }, { $addFields: { orderDate: { $dateFromString: { dateString: "$o_orderdate" } } } }, { $match: { $expr: { $gte: ["$orderDate", "$$threeMonthsAgo"] } } }, { $project: { "lineitem.l_partkey": 1, "_id": 0 } } ], as: "recent_orders" } }, { $unwind: "$recent_orders" }, { $lookup: { from: "partsupp_part", localField: "recent_orders.lineitem.l_partkey", foreignField: "p_partkey", as: "part_details" } }, { $unwind: "$part_details" }, { $group: { _id: "$part_details.p_name", total_orders: { $sum: 1 } } }, { $project: { p_name: "$_id", total_orders: 1, _id: 0 } }, { $sort: { total_orders: -1 } }, { $limit: 10 } ])
db.nation_region.aggregate([ { $unwind: "$nation" }, { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customer" } }, { $unwind: "$customer" }, { $lookup: { from: "lineitem_orders", localField: "customer.c_custkey", foreignField: "o_custkey", as: "order" } }, { $unwind: "$order" }, { $unwind: "$order.lineitem" }, { $group: { _id: "$nation.n_name", max_purchase: { $max: "$order.lineitem.l_extendedprice" } } }, { $sort: { max_purchase: -1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $facet: { customers: [ { $project: { c_name: 1, c_custkey: 1, orders: 1 } } ], maxDate: [ { $lookup: { from: "lineitem_orders", pipeline: [ { $project: { o_orderdate: { $toDate: "$o_orderdate" } } }, { $group: { _id: null, max_orderdate: { $max: "$o_orderdate" } } } ], as: "max_order" } }, { $unwind: "$max_order" }, { $project: { _id: 0, max_orderdate: "$max_order.max_orderdate" } } ] } }, { $project: { customers: 1, max_orderdate: { $arrayElemAt: ["$maxDate.max_orderdate", 0] } } }, { $unwind: "$customers" }, { $addFields: { cutoff_date: { $dateSubtract: { startDate: "$max_orderdate", unit: "month", amount: 6 } } } }, { $addFields: { hasRecentOrders: { $anyElementTrue: { $map: { input: "$customers.orders", as: "order", in: { $gte: [ { $toDate: "$$order.o_orderdate" }, "$cutoff_date" ] } } } } } }, { $match: { hasRecentOrders: false } }, { $project: { _id: 0, c_name: "$customers.c_name" } } ])
db.partsupp_part.aggregate([ { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $addFields: { delivery_time_days: { $dateDiff: { startDate: { $toDate: "$lineitems.l_commitdate" }, endDate: { $toDate: "$lineitems.l_shipdate" }, unit: "day" } } } }, { $group: { _id: "$p_name", max_delivery_time: { $max: "$delivery_time_days" } } }, { $sort: { max_delivery_time: -1 } }, { $project: { _id: 0, p_name: "$_id", max_delivery_time: 1 } } ])
db.nation_region.aggregate([ { $unwind: "$nation" }, { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$nation.n_name", max_order: { $max: "$orders.o_totalprice" } } }, { $sort: { max_order: -1 } }, { $project: { _id: 0, n_name: "$_id", max_order: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $unwind: "$orders.lineitem" }, { $group: { _id: "$c_name", unique_parts: { $addToSet: "$orders.lineitem.l_partkey" } } }, { $project: { unique_products: { $size: "$unique_parts" } } }, { $match: { unique_products: { $gte: 5 } } }, { $project: { _id: 0, c_name: "$_id", unique_products: 1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $addFields: { year: { $year: "$order_date" }, month: { $month: "$order_date" } } }, { $group: { _id: { year: "$year", month: "$month" }, top_orders: { $push: { o_orderkey: "$o_orderkey", o_totalprice: "$o_totalprice" } } } }, { $project: { _id: 0, year: "$_id.year", month: "$_id.month", top_orders: { $slice: [ { $sortArray: { input: "$top_orders", sortBy: { o_totalprice: -1 } } }, 5 ] } } } }, { $unwind: "$top_orders" }, { $project: { year: 1, month: 1, o_orderkey: "$top_orders.o_orderkey", o_totalprice: "$top_orders.o_totalprice" } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $unwind: "$orders.lineitem" }, { $match: { "orders.lineitem.l_returnflag": "R" } }, { $group: { _id: "$c_name", returns: { $count: {} } } }, { $sort: { returns: -1 } }, { $project: { _id: 0, c_name: "$_id", returns: 1 } } ])
db.partsupp_part.aggregate([ { $unwind: "$partsupp" }, { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "matching_lineitems" } }, { $unwind: "$matching_lineitems" }, { $match: { $expr: { $eq: ["$partsupp.ps_suppkey", "$matching_lineitems.l_suppkey"] } } }, { $lookup: { from: "supplier", localField: "partsupp.ps_suppkey", foreignField: "s_suppkey", as: "supplier" } }, { $unwind: "$supplier" }, { $group: { _id: { supplier_name: "$supplier.s_name", part_name: "$p_name" }, total_sales: { $sum: 1 } } }, { $sort: { "_id.supplier_name": 1, total_sales: -1 } }, { $project: { _id: 0, supplier_name: "$_id.supplier_name", part_name: "$_id.part_name", total_sales: 1 } } ])
db.supplier.aggregate([ { $lookup: { from: "partsupp", localField: "s_suppkey", foreignField: "ps_suppkey", as: "partsupps" } }, { $unwind: "$partsupps" }, { $lookup: { from: "lineitem", localField: "partsupps.ps_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $group: { _id: "$s_name", max_order_value: { $max: "$lineitems.l_extendedprice" } } }, { $sort: { max_order_value: -1 } }, { $project: { _id: 0, s_name: "$_id", max_order_value: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $unwind: "$orders.lineitem" }, { $lookup: { from: "supplier", localField: "orders.lineitem.l_suppkey", foreignField: "s_suppkey", as: "supplier" } }, { $unwind: "$supplier" }, { $lookup: { from: "nation_region", let: { nationkey: "$supplier.s_nationkey" }, pipeline: [ { $unwind: "$nation" }, { $match: { $expr: { $eq: ["$nation.n_nationkey", "$$nationkey"] } } }, { $project: { _id: 0, n_name: "$nation.n_name" } } ], as: "nation" } }, { $unwind: "$nation" }, { $group: { _id: "$c_name", countries: { $addToSet: "$nation.n_name" } } }, { $project: { countries: 1, num_countries: { $size: "$countries" } } }, { $match: { num_countries: { $gte: 10 } } }, { $project: { _id: 0, c_name: "$_id", countries: "$num_countries" } } ])
db.partsupp.aggregate([ { $lookup: { from: "supplier", localField: "ps_suppkey", foreignField: "s_suppkey", as: "supplier" } }, { $unwind: "$supplier" }, { $lookup: { from: "partsupp_part", localField: "ps_partkey", foreignField: "p_partkey", as: "part" } }, { $unwind: "$part" }, { $group: { _id: { s_name: "$supplier.s_name", p_name: "$part.p_name" }, min_cost: { $min: "$ps_supplycost" } } }, { $sort: { "_id.s_name": 1, min_cost: 1 } }, { $project: { _id: 0, s_name: "$_id.s_name", p_name: "$_id.p_name", min_cost: 1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $unwind: "$lineitem" }, { $addFields: { ship_date: { $toDate: "$lineitem.l_shipdate" } } }, { $addFields: { delivery_days: { $dateDiff: { startDate: "$order_date", endDate: "$ship_date", unit: "day" } } } }, { $group: { _id: "$o_orderkey", fastest_delivery_time: { $min: "$delivery_days" } } }, { $sort: { fastest_delivery_time: 1 } }, { $project: { _id: 0, o_orderkey: "$_id", fastest_delivery_time: 1 } } ])
db.lineitem.aggregate([ { $group: { _id: "$l_shipmode", usage_count: { $count: {} } } }, { $sort: { usage_count: -1 } }, { $project: { _id: 0, l_shipmode: "$_id", usage_count: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $addFields: { order_year: { $year: { $toDate: "$orders.o_orderdate" } } } }, { $group: { _id: "$c_name", years: { $addToSet: "$order_year" } } }, { $project: { num_years: { $size: "$years" } } }, { $match: { num_years: 5 } }, { $project: { _id: 0, c_name: "$_id" } } ])
db.lineitem.aggregate([ { $group: { _id: "$l_partkey", orderkeys: { $addToSet: "$l_orderkey" } } }, { $project: { l_partkey: "$_id", unique_orders: { $size: "$orderkeys" } } }, { $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part" } }, { $unwind: "$part" }, { $project: { _id: 0, p_name: "$part.p_name", unique_orders: 1 } }, { $sort: { unique_orders: -1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $addFields: { year: { $year: "$order_date" }, month: { $month: "$order_date" } } }, { $unwind: "$lineitem" }, { $lookup: { from: "partsupp_part", localField: "lineitem.l_partkey", foreignField: "p_partkey", as: "part" } }, { $unwind: "$part" }, { $group: { _id: { year: "$year", month: "$month", p_name: "$part.p_name" }, total_sales: { $sum: "$lineitem.l_extendedprice" } } }, { $sort: { "_id.year": -1, "_id.month": -1, total_sales: -1 } }, { $project: { _id: 0, year: "$_id.year", month: "$_id.month", p_name: "$_id.p_name", total_sales: 1 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $lookup: { from: "partsupp", localField: "lineitem.l_partkey", foreignField: "ps_partkey", as: "ps" } }, { $unwind: "$ps" }, { $addFields: { line_profit: { $subtract: [ "$lineitem.l_extendedprice", { $multiply: [ "$lineitem.l_quantity", "$ps.ps_supplycost" ] } ] } } }, { $group: { _id: "$o_orderkey", total_profit: { $sum: "$line_profit" } } }, { $sort: { total_profit: -1 } }, { $limit: 10 }, { $project: { _id: 0, o_orderkey: "$_id", total_profit: 1 } } ])
db.nation_region.aggregate([ { $unwind: "$nation" }, { $lookup: { from: "customer", localField: "nation.n_nationkey", foreignField: "c_nationkey", as: "customers" } }, { $unwind: "$customers" }, { $lookup: { from: "lineitem_orders", localField: "customers.c_custkey", foreignField: "o_custkey", as: "orders" } }, { $match: { "orders.0": { $exists: true } } }, { $group: { _id: "$nation.n_name", unique_customers: { $addToSet: "$customers.c_custkey" } } }, { $project: { n_name: "$_id", total_customers: { $size: "$unique_customers" }, _id: 0 } }, { $sort: { total_customers: -1 } } ])
db.lineitem_orders.aggregate([ { $project: { l_partkeys: { $map: { input: "$lineitem", as: "item", in: "$$item.l_partkey" } } } }, { $addFields: { l_partkeys: { $setUnion: ["$l_partkeys", []] } } }, { $project: { pairs: { $reduce: { input: "$l_partkeys", initialValue: [], in: { $concatArrays: [ "$$value", { $map: { input: { $filter: { input: "$l_partkeys", as: "p2", cond: { $gt: ["$$p2", "$$this"] } } }, as: "p2", in: { product_1: "$$this", product_2: "$$p2" } } } ] } } } } } }, { $unwind: "$pairs" }, { $group: { _id: { product_1: "$pairs.product_1", product_2: "$pairs.product_2" }, total_orders: { $sum: 1 } } }, { $sort: { total_orders: -1 } }, { $limit: 10 }, { $project: { _id: 0, product_1: "$_id.product_1", product_2: "$_id.product_2", total_orders: 1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $addFields: { year: { $year: "$order_date" }, month: { $month: "$order_date" } } }, { $unwind: "$lineitem" }, { $group: { _id: { year: "$year", month: "$month" }, max_discount: { $max: "$lineitem.l_discount" } } }, { $sort: { "_id.year": -1, "_id.month": -1, max_discount: -1 } }, { $project: { _id: 0, year: "$_id.year", month: "$_id.month", max_discount: 1 } } ])
db.lineitem.aggregate([ { $match: { l_returnflag: { $ne: null } } }, { $group: { _id: "$l_returnflag", total_returns: { $sum: 1 } } }, { $sort: { total_returns: -1 } }, { $project: { _id: 0, l_returnflag: "$_id", total_returns: 1 } } ])
db.partsupp.aggregate([ { $lookup: { from: "lineitem", localField: "ps_partkey", foreignField: "l_partkey", as: "matched_lines" } }, { $unwind: "$matched_lines" }, { $match: { $expr: { $eq: ["$ps_suppkey", "$matched_lines.l_suppkey"] } } }, { $lookup: { from: "supplier", localField: "ps_suppkey", foreignField: "s_suppkey", as: "supplier" } }, { $unwind: "$supplier" }, { $addFields: { shipping_cost: { $subtract: [ "$matched_lines.l_extendedprice", { $multiply: ["$matched_lines.l_quantity", "$ps_supplycost"] } ] } } }, { $group: { _id: "$supplier.s_name", max_shipping_cost: { $max: "$shipping_cost" } } }, { $sort: { max_shipping_cost: -1 } }, { $project: { _id: 0, s_name: "$_id", max_shipping_cost: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $addFields: { order_year: { $year: { $toDate: "$orders.o_orderdate" } } } }, { $group: { _id: { c_name: "$c_name", year: "$order_year" }, max_order_value: { $max: "$orders.o_totalprice" } } }, { $sort: { "_id.year": -1, max_order_value: -1 } }, { $project: { _id: 0, c_name: "$_id.c_name", year: "$_id.year", max_order_value: 1 } } ])
db.lineitem.aggregate([ { $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part" } }, { $unwind: "$part" }, { $addFields: { matched_partsupp: { $filter: { input: "$part.partsupp", as: "ps", cond: { $eq: ["$$ps.ps_suppkey", "$l_suppkey"] } } } } }, { $unwind: "$matched_partsupp" }, { $addFields: { line_profit: { $subtract: [ "$l_extendedprice", { $multiply: ["$l_quantity", "$matched_partsupp.ps_supplycost"] } ] } } }, { $group: { _id: "$part.p_name", total_profit: { $sum: "$line_profit" } } }, { $sort: { total_profit: -1 } }, { $project: { _id: 0, p_name: "$_id", total_profit: 1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $setWindowFields: { partitionBy: null, sortBy: { order_date: -1 }, output: { max_order_date: { $max: "$order_date" } } } }, { $match: { $expr: { $gte: [ "$order_date", { $dateSubtract: { startDate: "$max_order_date", unit: "month", amount: 3 } } ] } } }, { $project: { _id: 0, o_orderkey: 1, o_totalprice: 1 } }, { $sort: { o_totalprice: -1 } } ])
db.partsupp_part.aggregate([ { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "supplier", localField: "lineitems.l_suppkey", foreignField: "s_suppkey", as: "supplier" } }, { $unwind: "$supplier" }, { $lookup: { from: "nation_region", let: { nationkey: "$supplier.s_nationkey" }, pipeline: [ { $unwind: "$nation" }, { $match: { $expr: { $eq: ["$nation.n_nationkey", "$$nationkey"] } } }, { $project: { _id: 0, n_name: "$nation.n_name" } } ], as: "nation" } }, { $unwind: "$nation" }, { $group: { _id: "$p_name", countries: { $addToSet: "$nation.n_name" } } }, { $project: { _id: 0, p_name: "$_id", total_countries: { $size: "$countries" } } }, { $sort: { total_countries: -1 } } ])
db.lineitem.aggregate([ { $lookup: { from: "partsupp_part", localField: "l_partkey", foreignField: "p_partkey", as: "part" } }, { $unwind: "$part" }, { $addFields: { ship_date: { $toDate: "$l_shipdate" }, commit_date: { $toDate: "$l_commitdate" } } }, { $addFields: { delay_days: { $dateDiff: { startDate: "$commit_date", endDate: "$ship_date", unit: "day" } } } }, { $group: { _id: "$part.p_name", max_delay: { $max: "$delay_days" } } }, { $sort: { max_delay: -1 } }, { $project: { _id: 0, p_name: "$_id", max_delay: 1 } } ])
db.lineitem_orders.aggregate([ { $group: { _id: "$o_orderpriority", usage_count: { $sum: 1 } } }, { $sort: { usage_count: -1 } }, { $project: { _id: 0, o_orderpriority: "$_id", usage_count: 1 } } ])
db.lineitem_orders.aggregate([ { $addFields: { order_date: { $toDate: "$o_orderdate" } } }, { $lookup: { from: "customer", localField: "o_custkey", foreignField: "c_custkey", as: "customer" } }, { $unwind: "$customer" }, { $setWindowFields: { partitionBy: "$o_custkey", sortBy: { order_date: 1 }, output: { prev_order_date: { $shift: { by: -1, output: "$order_date" } } } } }, { $addFields: { days_between: { $cond: { if: { $and: ["$prev_order_date", "$order_date"] }, then: { $dateDiff: { startDate: "$prev_order_date", endDate: "$order_date", unit: "day" } }, else: null } } } }, { $project: { _id: 0, c_name: "$customer.c_name", o_orderdate: 1, prev_order: "$prev_order_date", days_between: 1 } } ])
db.lineitem_orders.aggregate([{$addFields:{order_date:{$toDate:"$o_orderdate"}}},{$addFields:{year:{$year:"$order_date"},month:{$month:"$order_date"}}},{$setWindowFields:{partitionBy:{year:"$year",month:"$month"},sortBy:{order_date:1},output:{avg_monthly_price:{$avg:"$o_totalprice"}}}},{$match:{$expr:{$gt:["$o_totalprice","$avg_monthly_price"]}}},{$project:{_id:0,o_orderkey:1,o_totalprice:1,year:1,month:1}}])
db.lineitem.aggregate([{$addFields:{orderkey:"$l_orderkey"}},{$setWindowFields:{partitionBy:"$l_orderkey",sortBy:{l_discount:1},output:{prev_discount:{$shift:{by:-1,output:"$l_discount"}}}}},{$addFields:{discount_trend:{$switch:{branches:[{case:{$gt:["$l_discount","$prev_discount"]},then:"Discount Increased"},{case:{$lt:["$l_discount","$prev_discount"]},then:"Discount Decreased"}],default:"No Change"}}}},{$project:{_id:0,o_orderkey:"$l_orderkey",l_discount:1,prev_discount:1,discount_trend:1}}])
db.lineitem.aggregate([{$lookup:{from:"supplier",localField:"l_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$group:{_id:"$supplier.s_name",n:{$sum:1},sum:{$sum:"$l_quantity"},sumSq:{$sum:{$multiply:["$l_quantity","$l_quantity"]}}}},{$addFields:{supply_variation:{$sqrt:{$subtract:[{$divide:["$sumSq","$n"]},{$pow:[{$divide:["$sum","$n"]},2]}]}}}},{$sort:{supply_variation:1}},{$project:{_id:0,s_name:"$_id",supply_variation:1}}])
db.lineitem_orders.aggregate([{$addFields:{order_date:{$toDate:"$o_orderdate"}}},{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$setWindowFields:{partitionBy:"$o_custkey",sortBy:{order_date:1},output:{prev_order_value:{$shift:{by:-1,output:"$o_totalprice"}}}}},{$addFields:{order_trend:{$cond:{if:{$gt:["$o_totalprice",{$multiply:["$prev_order_value",1.5]}]},then:"Significant Increase",else:"Stable"}}}},{$project:{_id:0,c_name:"$customer.c_name",o_totalprice:1,prev_order_value:1,order_trend:1}}])
db.lineitem.aggregate([{$lookup:{from:"lineitem_orders",localField:"l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$lookup:{from:"supplier",localField:"l_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$addFields:{order_date:{$toDate:"$order.o_orderdate"}}},{$group:{_id:{suppkey:"$supplier.s_suppkey",s_name:"$supplier.s_name",order_date:"$order_date"},current_volume:{$sum:"$l_quantity"}}},{$setWindowFields:{partitionBy:"$_id.suppkey",sortBy:{"_id.order_date":1},output:{prev_volume:{$shift:{by:-1,output:"$current_volume"}}}}},{$addFields:{supply_trend:{$cond:{if:{$lt:["$current_volume","$prev_volume"]},then:"Volume Decreased",else:"Stable"}}}},{$project:{_id:0,s_name:"$_id.s_name",order_date:"$_id.order_date",current_volume:1,prev_volume:1,supply_trend:1}},{$sort:{s_name:1,order_date:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$match:{"lines.0":{$exists:true}}},{$project:{p_name:1,max_price:{$max:"$lines.l_extendedprice"},min_price:{$min:"$lines.l_extendedprice"}}},{$addFields:{price_variation:{$subtract:["$max_price","$min_price"]}}},{$sort:{price_variation:-1}},{$project:{_id:0,p_name:1,price_variation:1}}])
db.lineitem.aggregate([{$lookup:{from:"supplier",localField:"l_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$addFields:{order_date:{$toDate:"$l_shipdate"}}},{$group:{_id:{s_name:"$supplier.s_name",s_suppkey:"$supplier.s_suppkey",order_date:"$order_date"},current_volume:{$sum:"$l_quantity"}}},{$setWindowFields:{partitionBy:"$_id.s_suppkey",sortBy:{"_id.order_date":1},output:{prev_volume:{$shift:{by:-1,output:"$current_volume"}}}}},{$addFields:{growth_rate:{$cond:{if:{$and:[{$ne:["$prev_volume",0]},{ $ne:["$prev_volume",null]}]},then:{$divide:[{$subtract:["$current_volume","$prev_volume"]},"$prev_volume"]},else:null}}}},{$match:{growth_rate:{$ne:null}}},{$sort:{growth_rate:-1}},{$limit:5},{$project:{_id:0,s_name:"$_id.s_name",growth_rate:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$match:{"lines.0":{$exists:true}}},{$project:{p_name:1,delivery_durations:{$map:{input:"$lines",as:"line",in:{$dateDiff:{startDate:{$toDate:"$$line.l_commitdate"},endDate:{$toDate:"$$line.l_shipdate"},unit:"day"}}}}}},{$project:{p_name:1,delivery_variation:{$subtract:[{$max:"$delivery_durations"},{$min:"$delivery_durations"}]}}},{$sort:{delivery_variation:-1}},{$project:{_id:0,p_name:1,delivery_variation:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"lineitem_orders",localField:"lines.l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$addFields:{order_month:{$month:{$toDate:"$order.o_orderdate"}}}},{$addFields:{first_half:{$cond:[{$lte:["$order_month",6]},1,0]},second_half:{$cond:[{$gt:["$order_month",6]},1,0]}}},{$group:{_id:"$p_name",first_half_orders:{$sum:"$first_half"},second_half_orders:{$sum:"$second_half"}}},{$match:{$expr:{$gt:["$second_half_orders","$first_half_orders"]}}},{$project:{_id:0,p_name:"$_id",first_half_orders:1,second_half_orders:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$match:{"lines.0":{$exists:true}}},{$project:{p_name:1,price_diff:{$subtract:[{$max:"$lines.l_extendedprice"},{$min:"$lines.l_extendedprice"}]}}},{$sort:{price_diff:-1}},{$project:{_id:0,p_name:1,price_diff:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$addFields:{order_month:{$month:{$toDate:"$o_orderdate"}}}},{$group:{_id:{c_name:"$customer.c_name",order_month:"$order_month"},total_orders:{$count:{}}}},{$project:{_id:0,c_name:"$_id.c_name",order_month:"$_id.order_month",total_orders:1}},{$sort:{c_name:1,order_month:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$project:{p_name:1,discounts:{$filter:{input:"$lines",as:"line",cond:{$gt:["$$line.l_discount",0]}}}}},{$project:{p_name:1,distinct_discounts:{$setUnion:[{$map:{input:"$discounts",as:"d",in:"$$d.l_discount"}},[]]}}},{$addFields:{discount_count:{$size:"$distinct_discounts"}}},{$match:{discount_count:{$gte:3}}},{$project:{_id:0,p_name:1,discount_count:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$addFields:{order_date:{$toDate:"$o_orderdate"}}},{$setWindowFields:{partitionBy:"$o_custkey",sortBy:{order_date:1},output:{prev_order_value:{$shift:{by:-1,output:"$o_totalprice"}}}}},{$addFields:{order_pattern:{$cond:{if:{$gt:["$o_totalprice",{ $multiply: ["$prev_order_value", 2] }]},then:"Significant Increase",else:"Stable"}}}},{$project:{_id:0,c_name:"$customer.c_name",o_totalprice:1,prev_order_value:1,order_pattern:1}}])
db.lineitem.aggregate([{$addFields:{receipt_date:{$toDate:"$l_receiptdate"},ship_date:{$toDate:"$l_shipdate"}}},{$addFields:{payment_delay:{$dateDiff:{startDate:"$ship_date",endDate:"$receipt_date",unit:"day"}}}},{$group:{_id:"$l_orderkey",max_delay:{$max:"$payment_delay"}}},{$sort:{max_delay:-1}},{$limit:10},{$project:{_id:0,l_orderkey:"$_id",payment_delay_days:"$max_delay"}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$match:{"lines.0":{$exists:true}}},{$project:{p_name:1,n:{$size:"$lines"},sum:{$sum:"$lines.l_extendedprice"},sumSq:{$sum:{$map:{input:"$lines",as:"line",in:{$multiply:["$$line.l_extendedprice","$$line.l_extendedprice"]}}}}}},{$addFields:{price_volatility:{$subtract:[{$divide:["$sumSq","$n"]},{$pow:[{$divide:["$sum","$n"]},2]}]}}},{$sort:{price_volatility:-1}},{$project:{_id:0,p_name:1,price_volatility:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$lookup:{from:"nation_region",let:{nationkey:"$customer.c_nationkey"},pipeline:[{$unwind:"$nation"},{$match:{$expr:{$eq:["$nation.n_nationkey","$$nationkey"]}}},{$project:{_id:0,n_name:"$nation.n_name"}}],as:"nation"}},{$unwind:"$nation"},{$addFields:{order_year:{$year:{$toDate:"$o_orderdate"}}}},{$group:{_id:{n_name:"$nation.n_name",order_year:"$order_year"},total_orders:{$count:{}}}},{$setWindowFields:{partitionBy:"$_id.n_name",sortBy:{"_id.order_year":1},output:{prev_year_orders:{$shift:{by:-1,output:"$total_orders"}}}}},{$addFields:{growth:{$subtract:["$total_orders",{ $ifNull: ["$prev_year_orders", 0] }]}}},{$project:{_id:0,n_name:"$_id.n_name",order_year:"$_id.order_year",total_orders:1,prev_year_orders:1,growth:1}},{$sort:{n_name:1,order_year:1}}])
db.lineitem_orders.aggregate([{$addFields:{order_date:{$toDate:"$o_orderdate"}}},{$addFields:{year:{$year:"$order_date"},month:{$month:"$order_date"}}},{$group:{_id:{year:"$year",month:"$month"},total_sales:{$sum:"$o_totalprice"}}},{$sort:{total_sales:-1}},{$project:{_id:0,year:"$_id.year",month:"$_id.month",total_sales:1}}])
db.lineitem.aggregate([{$match:{l_returnflag:"R"}},{$lookup:{from:"partsupp",localField:"l_partkey",foreignField:"ps_partkey",as:"ps"}},{$unwind:"$ps"},{$lookup:{from:"supplier",localField:"ps.ps_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$group:{_id:"$supplier.s_name",total_returns:{$sum:1}}},{$sort:{total_returns:-1}},{$project:{_id:0,s_name:"$_id",total_returns:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$group:{_id:"$customer.c_name",max_order:{$max:"$o_totalprice"},min_order:{$min:"$o_totalprice"}}},{$addFields:{order_variation:{$subtract:["$max_order","$min_order"]}}},{$sort:{order_variation:-1}},{$project:{_id:0,c_name:"$_id",order_variation:1}}])
db.lineitem.aggregate([{$setWindowFields:{partitionBy:"$l_orderkey",sortBy:{l_discount:1},output:{next_discount:{$shift:{by:1,output:"$l_discount"}}}}},{$addFields:{discount_trend:{$cond:{if:{$gt:["$next_discount","$l_discount"]},then:"Increasing",else:"Decreasing or Stable"}}}},{$project:{_id:0,o_orderkey:"$l_orderkey",l_discount:1,next_discount:1,discount_trend:1}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"lineitem_orders",localField:"lines.l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$addFields:{order_month:{$month:{$toDate:"$order.o_orderdate"}}}},{$match:{order_month:{$lte:6}}},{$group:{_id:"$p_name"}},{$project:{_id:0,p_name:"$_id"}}])
db.partsupp_part.aggregate([{$lookup:{from:"lineitem",localField:"p_partkey",foreignField:"l_partkey",as:"lines"}},{$match:{"lines.0":{$exists:true}}},{$project:{p_name:1,max_discount:{$max:"$lines.l_discount"}}},{$sort:{max_discount:-1}},{$project:{_id:0,p_name:1,max_discount:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$group:{_id:"$customer.c_name",n:{$sum:1},sum:{$sum:"$o_totalprice"},sumSq:{$sum:{$multiply:["$o_totalprice","$o_totalprice"]}}}},{$addFields:{price_variability:{$sqrt:{$subtract:[{$divide:["$sumSq","$n"]},{$pow:[{$divide:["$sum","$n"]},2]}]}}}},{$sort:{price_variability:-1}},{$project:{_id:0,c_name:"$_id",price_variability:1}}])
db.lineitem.aggregate([{$lookup:{from:"lineitem_orders",localField:"l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$lookup:{from:"customer",localField:"order.o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$lookup:{from:"partsupp",localField:"l_partkey",foreignField:"ps_partkey",as:"partsupp"}},{$unwind:"$partsupp"},{$lookup:{from:"supplier",localField:"partsupp.ps_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$group:{_id:"$customer.c_name",supplier_set:{$addToSet:"$supplier.s_name"}}},{$addFields:{supplier_count:{$size:"$supplier_set"}}},{$match:{supplier_count:{$gt:1}}},{$project:{_id:0,c_name:"$_id",supplier_count:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$addFields:{order_month:{$month:{$toDate:"$o_orderdate"}}}},{$group:{_id:"$customer.c_name",months:{$addToSet:"$order_month"}}},{$match:{$expr:{$eq:[{$size:"$months"},12]}}},{$project:{_id:0,c_name:"$_id"}}])
db.lineitem.aggregate([{$lookup:{from:"lineitem_orders",localField:"l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$lookup:{from:"partsupp",localField:"l_partkey",foreignField:"ps_partkey",as:"ps"}},{$unwind:"$ps"},{$lookup:{from:"supplier",localField:"ps.ps_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$addFields:{order_date:{$toDate:"$order.o_orderdate"}}},{$group:{_id:{s_suppkey:"$supplier.s_suppkey",s_name:"$supplier.s_name",order_date:"$order_date"},current_volume:{$sum:"$l_quantity"}}},{$setWindowFields:{partitionBy:"$_id.s_suppkey",sortBy:{"_id.order_date":1},output:{prev_volume:{$shift:{by:-1,output:"$current_volume"}}}}},{$addFields:{supply_trend:{$cond:{if:{$gt:["$current_volume","$prev_volume"]},then:"Increasing",else:"Decreasing or Stable"}}}},{$project:{_id:0,s_name:"$_id.s_name",order_date:"$_id.order_date",current_volume:1,prev_volume:1,supply_trend:1}},{$sort:{s_name:1,order_date:1}}])
db.supplier.aggregate([{$lookup:{from:"partsupp",localField:"s_suppkey",foreignField:"ps_suppkey",as:"parts"}},{$unwind:"$parts"},{$lookup:{from:"lineitem",localField:"parts.ps_partkey",foreignField:"l_partkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"lineitem_orders",localField:"lines.l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$addFields:{order_date:{$toDate:"$order.o_orderdate"}}},{$group:{_id:{s_suppkey:"$s_suppkey",s_name:"$s_name",order_date:"$order_date"},current_volume:{$sum:"$lines.l_quantity"}}},{$setWindowFields:{partitionBy:"$_id.s_suppkey",sortBy:{"_id.order_date":1},output:{prev_volume:{$shift:{by:-1,output:"$current_volume"}}}}},{$addFields:{loss:{$subtract:["$current_volume",{ $ifNull: ["$prev_volume", 0] }]}}},{$project:{_id:0,s_name:"$_id.s_name",order_date:"$_id.order_date",current_volume:1,prev_volume:1,loss:1}},{$sort:{s_name:1,order_date:1}}])
db.customer.aggregate([{$lookup:{from:"lineitem_orders",localField:"c_custkey",foreignField:"o_custkey",as:"orders"}},{$unwind:"$orders"},{$lookup:{from:"lineitem",localField:"orders.o_orderkey",foreignField:"l_orderkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"supplier",localField:"lines.l_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$lookup:{from:"nation_region",let:{nationkey:"$supplier.s_nationkey"},pipeline:[{$unwind:"$nation"},{$match:{$expr:{$eq:["$nation.n_nationkey","$$nationkey"]}}},{$project:{n_name:"$nation.n_name",_id:0}}],as:"nation"}},{$unwind:"$nation"},{$group:{_id:"$c_name",countries:{$addToSet:"$nation.n_name"}}},{$addFields:{num_countries:{$size:"$countries"}}},{$match:{num_countries:{$gte:5}}},{$project:{_id:0,c_name:"$_id",num_countries:1}}])
db.partsupp_part.aggregate([{$match:{"partsupp.0":{$exists:true}}},{$project:{p_name:1,max_cost:{$max:"$partsupp.ps_supplycost"},min_cost:{$min:"$partsupp.ps_supplycost"}}},{$addFields:{price_variability:{$subtract:["$max_cost","$min_cost"]}}},{$sort:{price_variability:-1}},{$project:{_id:0,p_name:1,price_variability:1}}])
db.customer.aggregate([{$lookup:{from:"lineitem_orders",localField:"c_custkey",foreignField:"o_custkey",as:"orders"}},{$unwind:"$orders"},{$lookup:{from:"lineitem",localField:"orders.o_orderkey",foreignField:"l_orderkey",as:"lines"}},{$unwind:"$lines"},{$group:{_id:"$c_name",unique_products:{$addToSet:"$lines.l_partkey"}}},{$addFields:{product_count:{$size:"$unique_products"}}},{$match:{product_count:{$gte:3}}},{$project:{_id:0,c_name:"$_id",unique_products:"$product_count"}}])
db.customer.aggregate([{$lookup:{from:"lineitem_orders",localField:"c_custkey",foreignField:"o_custkey",as:"orders"}},{$unwind:"$orders"},{$lookup:{from:"lineitem",localField:"orders.o_orderkey",foreignField:"l_orderkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"partsupp_part",localField:"lines.l_partkey",foreignField:"p_partkey",as:"part"}},{$unwind:"$part"},{$group:{_id:{c_name:"$c_name",p_name:"$part.p_name"},highest_price:{$max:"$lines.l_extendedprice"}}},{$sort:{highest_price:-1}},{$project:{_id:0,c_name:"$_id.c_name",p_name:"$_id.p_name",highest_price:1}}])
db.lineitem_orders.aggregate([{$setWindowFields:{output:{global_avg:{$avg:"$o_totalprice"}}}},{$match:{$expr:{$gt:["$o_totalprice",{$multiply:["$global_avg",2]}]}}},{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$group:{_id:"$customer.c_name"}},{$project:{_id:0,c_name:"$_id"}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$lookup:{from:"lineitem",localField:"o_orderkey",foreignField:"l_orderkey",as:"lines"}},{$unwind:"$lines"},{$lookup:{from:"partsupp",localField:"lines.l_partkey",foreignField:"ps_partkey",as:"partsupp"}},{$unwind:"$partsupp"},{$lookup:{from:"supplier",localField:"partsupp.ps_suppkey",foreignField:"s_suppkey",as:"supplier"}},{$unwind:"$supplier"},{$group:{_id:{c_name:"$customer.c_name",s_name:"$supplier.s_name"},total_orders:{$count:{}}}},{$sort:{total_orders:-1}},{$project:{_id:0,c_name:"$_id.c_name",s_name:"$_id.s_name",total_orders:1}}])
db.supplier.aggregate([{$lookup:{from:"partsupp",localField:"s_suppkey",foreignField:"ps_suppkey",as:"partsupp"}},{$unwind:"$partsupp"},{$lookup:{from:"partsupp_part",localField:"partsupp.ps_partkey",foreignField:"p_partkey",as:"part"}},{$unwind:"$part"},{$lookup:{from:"lineitem",localField:"part.p_partkey",foreignField:"l_partkey",as:"lineitems"}},{$match:{"lineitems.l_partkey":{$exists:true}}},{$group:{_id:{s_name:"$s_name",p_name:"$part.p_name"},total_purchases:{$sum:{$size:"$lineitems"}}}},{$sort:{total_purchases:-1}},{$project:{_id:0,s_name:"$_id.s_name",p_name:"$_id.p_name",total_purchases:1}},{$limit:10}])
db.lineitem.aggregate([{$lookup:{from:"lineitem_orders",localField:"l_orderkey",foreignField:"o_orderkey",as:"order"}},{$unwind:"$order"},{$lookup:{from:"partsupp_part",localField:"l_partkey",foreignField:"p_partkey",as:"part"}},{$unwind:"$part"},{$addFields:{delivery_time:{$subtract:[{$toDate:"$l_shipdate"},{$toDate:"$order.o_orderdate"}]}}},{$group:{_id:{p_name:"$part.p_name",l_shipmode:"$l_shipmode"},fastest_delivery:{$min:"$delivery_time"}}},{$sort:{fastest_delivery:1}},{$project:{_id:0,p_name:"$_id.p_name",l_shipmode:"$_id.l_shipmode",fastest_delivery:1}}])
db.lineitem_orders.aggregate([{$lookup:{from:"customer",localField:"o_custkey",foreignField:"c_custkey",as:"customer"}},{$unwind:"$customer"},{$project:{"customer.c_name":1,"o_orderkey":1,"o_totalprice":1,"o_orderdate":1}}])
db.supplier.aggregate([{$lookup:{from:"partsupp",localField:"s_suppkey",foreignField:"ps_suppkey",as:"partsupp"}},{$unwind:"$partsupp"},{$lookup:{from:"lineitem",localField:"partsupp.ps_partkey",foreignField:"l_partkey",as:"lineitem"}},{$unwind:"$lineitem"},{$lookup:{from:"lineitem_orders",localField:"lineitem.l_orderkey",foreignField:"o_orderkey",as:"orders"}},{$unwind:"$orders"},{$addFields:{order_year:{$year:{$toDate:"$orders.o_orderdate"}}}},{$group:{_id:{s_name:"$s_name",order_year:"$order_year"},max_order:{$max:"$orders.o_totalprice"}}},{$project:{_id:0,s_name:"$_id.s_name",order_year:"$_id.order_year",max_order:1}}])
db.lineitem_orders.aggregate([{$addFields:{day_of_week:{$dayOfWeek:{$toDate:"$o_orderdate"}}}},{$group:{_id:"$day_of_week",order_count:{$sum:1}}},{$sort:{order_count:-1}},{$project:{_id:0,day_of_week:"$_id",order_count:1}}])
db.lineitem_orders.aggregate([{$project:{day_of_week:{$dayOfWeek:{$toDate:"$o_orderdate"}}}},{$group:{_id:"$day_of_week",order_count:{$sum:1}}},{$sort:{order_count:-1}}])
db.partsupp.aggregate([{ $lookup: { from: "lineitem", localField: "ps_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $match: { "lineitems.l_returnflag": "R" } }, { $group: { _id: "$p_name", earliest_return: { $min: "$lineitems.l_shipdate" } } }, { $sort: { earliest_return: 1 } }, { $project: { _id: 0, p_name: "$_id", earliest_return: 1 } }, { $limit: 100 }])
db.lineitem.aggregate([ { $project: { l_shipmode: 1, delay: { $subtract: [ { $toDate: "$l_shipdate" }, { $toDate: "$l_commitdate" } ] } } }, { $group: { _id: "$l_shipmode", avg_delay: { $avg: "$delay" } } }, { $sort: { avg_delay: -1 } }, { $project: { _id: 0, l_shipmode: "$_id", avg_delay: 1 } } ])
db.partsupp.aggregate([ { $lookup: { from: "lineitem", localField: "ps_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "lineitem_orders", localField: "lineitems.l_orderkey", foreignField: "o_orderkey", as: "orders" } }, { $unwind: "$orders" }, { $project: { p_name: 1, year: { $year: { $toDate: "$orders.o_orderdate" } }, month: { $month: { $toDate: "$orders.o_orderdate" } }, l_extendedprice: "$lineitems.l_extendedprice" } }, { $group: { _id: { p_name: "$p_name", year: "$year", month: "$month" }, total_sales: { $sum: "$l_extendedprice" } } }, { $sort: { total_sales: -1 } }, { $project: { _id: 0, p_name: "$_id.p_name", year: "$_id.year", month: "$_id.month", total_sales: 1 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $group: { _id: "$c_name", maxTotalPrice: { $max: "$orders.o_totalprice" } } }, { $lookup: { from: "lineitem_orders", pipeline: [ { $group: { _id: null, avgTotalPrice: { $avg: "$o_totalprice" } } } ], as: "avgPrice" } }, { $unwind: "$avgPrice" }, { $match: { $expr: { $lt: ["$maxTotalPrice", "$avgPrice.avgTotalPrice"] } } }, { $project: { c_name: "$_id", _id: 0 } } ])
db.lineitem_orders.aggregate([ { $unwind: "$lineitem" }, { $match: { "lineitem.l_returnflag": "R" } }, { $addFields: { order_date: { $dateFromString: { dateString: "$o_orderdate" } }, return_day: { $dayOfWeek: { $dateFromString: { dateString: "$o_orderdate" } } } } }, { $group: { _id: "$return_day", return_count: { $sum: 1 } } }, { $sort: { return_count: -1 } }, { $project: { return_day: "$_id", return_count: 1, _id: 0 } } ])
db.partsupp_part.aggregate([ { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "lineitem_orders", localField: "lineitems.l_orderkey", foreignField: "o_orderkey", as: "orders" } }, { $unwind: "$orders" }, { $addFields: { order_date: { $dateFromString: { dateString: "$orders.o_orderdate" } }, order_day: { $dayOfWeek: { $dateFromString: { dateString: "$orders.o_orderdate" } } } } }, { $match: { order_day: { $in: [6, 7] } } }, { $group: { _id: "$p_name" } }, { $project: { p_name: "$_id", _id: 0 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $unwind: "$orders" }, { $addFields: { year: { $year: { $dateFromString: { dateString: "$orders.o_orderdate" } } }, total_spent: "$orders.o_totalprice" } }, { $group: { _id: { c_name: "$c_name", c_custkey: "$c_custkey", year: "$year" }, total_spent: { $sum: "$total_spent" } } }, { $sort: { "_id.c_custkey": 1, "_id.year": 1 } }, { $group: { _id: { c_name: "$_id.c_name", c_custkey: "$_id.c_custkey" }, years: { $push: { year: "$_id.year", total_spent: "$total_spent" } } } }, { $addFields: { years_with_growth: { $map: { input: "$years", as: "current_year", in: { $let: { vars: { prev_year: { $cond: { if: { $eq: [{ $size: "$years" }, 1] }, then: 0, else: { $arrayElemAt: [ "$years", { $subtract: [ { $indexOfArray: ["$years.year", "$$current_year.year"] }, 1 ] } ] } } } }, in: { year: "$$current_year.year", total_spent: "$$current_year.total_spent", prev_year_spent: { $ifNull: ["$$prev_year.total_spent", 0] }, growth: { $subtract: [ "$$current_year.total_spent", { $ifNull: ["$$prev_year.total_spent", 0] } ] } } } } } } } }, { $unwind: "$years_with_growth" }, { $project: { c_name: "$_id.c_name", year: "$years_with_growth.year", total_spent: "$years_with_growth.total_spent", prev_year_spent: "$years_with_growth.prev_year_spent", growth: "$years_with_growth.growth", _id: 0 } }, { $sort: { growth: -1 } } ])
db.partsupp_part.aggregate([ { $lookup: { from: "lineitem", localField: "p_partkey", foreignField: "l_partkey", as: "lineitems" } }, { $unwind: "$lineitems" }, { $lookup: { from: "lineitem_orders", localField: "lineitems.l_orderkey", foreignField: "o_orderkey", as: "orders" } }, { $unwind: "$orders" }, { $addFields: { day_of_week: { $dayOfWeek: { $dateFromString: { dateString: "$orders.o_orderdate" } } } } }, { $match: { day_of_week: 1 } }, { $group: { _id: "$p_name" } }, { $project: { p_name: "$_id", _id: 0 } } ])
db.customer.aggregate([ { $lookup: { from: "lineitem_orders", localField: "c_custkey", foreignField: "o_custkey", as: "orders" } }, { $match: { "orders": { $ne: [] } } }, { $unwind: "$orders" }, { $addFields: { order_date: { $dateFromString: { dateString: "$orders.o_orderdate" } }, day_of_week: { $dayOfWeek: { $dateFromString: { dateString: "$orders.o_orderdate" } } } } }, { $match: { day_of_week: { $eq: 1 } } }, { $group: { _id: { c_name: "$c_name", o_orderdate: "$orders.o_orderdate" }, daily_orders: { $sum: 1 } } }, { $project: { c_name: "$_id.c_name", o_orderdate: "$_id.o_orderdate", daily_orders: 1, _id: 0 } }, { $sort: { daily_orders: -1 } } ])